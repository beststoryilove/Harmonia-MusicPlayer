<!DOCTYPE html>
<!-- å¼•ç”¨è‡ªä¸Šä¼ æ–‡ä»¶ä»¥åšä¿®æ”¹ï¼š:contentReference[oaicite:0]{index=0} -->
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="description" content="Harmonia - ä¸€ä¸ªç¾è§‚æ˜“ç”¨çš„åœ¨çº¿éŸ³ä¹æ’­æ”¾å™¨ï¼Œæ”¯æŒæ­Œè¯æ˜¾ç¤ºã€æ’­æ”¾åˆ—è¡¨ç®¡ç†å’Œå¤šä¸»é¢˜åˆ‡æ¢" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Harmonia - éŸ³ä¹æ’­æ”¾å™¨</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI','PingFang SC','Microsoft YaHei',sans-serif;}
    body{
      background-color:#0a0a12;color:#fff;min-height:100vh;display:flex;padding:20px;
      background:linear-gradient(135deg,#1a1a2e,#16213e,#0f3460);position:relative;overflow-x:hidden;transition:background .5s ease;
    }
    body.light-theme{background:linear-gradient(135deg,#e0e7ff,#dbeafe,#d1d5db);color:#1e293b;}

    .save-wallpaper{
      position:fixed;bottom:20px;right:20px;padding:12px 18px;border:none;border-radius:30px;cursor:pointer;font-size:14px;
      z-index:100;display:none;color:#fff;background:linear-gradient(135deg,#8e44ad,#9b59b6);box-shadow:0 4px 20px rgba(142,68,173,.3);transition:all .3s;font-weight:600;
    }
    .save-wallpaper:hover{background:linear-gradient(135deg,#9b59b6,#8e44ad);transform:translateY(-2px)}
    .desktop-lyrics-btn{
      position:fixed;bottom:160px;right:20px;padding:12px 18px;border:none;border-radius:30px;cursor:pointer;font-size:14px;z-index:100;
      color:#fff;background:linear-gradient(135deg,#3498db,#2980b9);box-shadow:0 4px 20px rgba(52,152,219,.3);transition:all .3s;font-weight:600;display:flex;align-items:center;gap:8px;white-space:nowrap;
    }
    .desktop-lyrics-btn::before{content:'ğŸ¤';font-size:16px}
    .desktop-lyrics-status{
      position:fixed;bottom:120px;right:20px;padding:8px 15px;border-radius:30px;font-size:12px;z-index:99;display:none;
      background:rgba(30,22,45,.85);border:1px solid rgba(255,255,255,.1);color:#aaa;
    }
    .desktop-lyrics-status.connected{color:#2ecc71}
    .desktop-lyrics-status.disconnected{color:#e74c3c}

    .share-music{
      position:fixed;bottom:90px;right:20px;padding:12px 18px;border:none;border-radius:30px;cursor:pointer;font-size:14px;z-index:100;font-weight:600;
      color:#fff;background:linear-gradient(135deg,#6c5ce7,#5d4bdb);box-shadow:0 4px 20px rgba(108,92,231,.3);transition:all .3s;display:flex;align-items:center;gap:8px;white-space:nowrap;
    }
    .share-music::before{content:'ğŸµ';font-size:16px}

    .theme-toggle{
      position:fixed;top:20px;right:20px;width:50px;height:50px;border-radius:50%;
      background:rgba(30,22,45,.85);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.12);
      display:flex;align-items:center;justify-content:center;cursor:pointer;z-index:100;box-shadow:0 4px 15px rgba(0,0,0,.3);transition:all .3s;
    }
    .theme-toggle i{font-size:24px;color:#9b59b6}

    .top-info-bar{
      position:fixed;top:0;left:0;width:100%;background:rgba(30,22,45,.9);
      backdrop-filter:blur(10px);border-bottom:1px solid rgba(255,255,255,.1);z-index:1000;padding:8px 0;font-size:12px;
    }
    .top-info-content{display:flex;justify-content:space-between;align-items:center;max-width:1400px;margin:0 auto;padding:0 20px}
    .top-terms-link{color:#9b59b6;text-decoration:none}
    .top-terms-link:hover{text-decoration:underline}

    .main-wrapper{display:flex;width:100%;max-width:1400px;margin:60px auto 0;gap:20px;min-height:0}
    .playlist-container{
      width:250px;background:rgba(30,22,45,.85);border-radius:16px;padding:15px;backdrop-filter:blur(10px);
      box-shadow:0 12px 30px rgba(0,0,0,.6);border:1px solid rgba(255,255,255,.12);overflow:hidden;display:flex;flex-direction:column;animation:slideInLeft .6s ease-out;
    }
    .playlist-tabs{display:flex;margin-bottom:15px;border-bottom:1px solid rgba(255,255,255,.1)}
    .playlist-tab{padding:8px 15px;cursor:pointer;font-size:14px;font-weight:500;color:#aaa;transition:all .3s;border-bottom:2px solid transparent}
    .playlist-tab.active{color:#9b59b6;border-bottom:2px solid #9b59b6;font-weight:600}

    .playlist-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;padding-bottom:10px;border-bottom:1px solid rgba(255,255,255,.1)}
    .playlist-title{font-size:18px;font-weight:700;color:#9b59b6;letter-spacing:.5px}
    .clear-playlist{background:none;border:none;color:#aaa;cursor:pointer;font-size:12px;transition:all .2s;padding:5px 8px;border-radius:4px}
    .clear-playlist:hover{color:#ff4d4d;background:rgba(255,77,77,.1)}

    /* æŠ˜å æ§ä»¶ï¼ˆä»…ç”¨äºå·¦ä¾§åˆ—è¡¨ï¼‰ */
    .header-actions{display:flex;align-items:center;gap:8px}
    .collapse-toggle{
      background:none;border:none;color:#aaa;cursor:pointer;width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;transition:all .2s ease;
    }
    .collapse-toggle:hover{background:rgba(255,255,255,.1);color:#9b59b6}
    .collapse-toggle i{transition:transform .25s ease}
    .playlist-collapsible.hidden{display:none}

    .playlist-items{flex:1;overflow-y:auto}
    .playlist-item{
      padding:12px 15px;margin-bottom:8px;border-radius:10px;background:rgba(0,0,0,.25);cursor:pointer;display:flex;justify-content:space-between;align-items:center;
      transition:all .3s ease;border-left:3px solid transparent;animation:fadeIn .5s ease;
    }
    .playlist-item:hover{background:rgba(255,255,255,.12);transform:translateY(-2px)}
    .playlist-item.active{background:linear-gradient(90deg,rgba(155,89,182,.15),rgba(155,89,182,.05));border-left:3px solid #9b59b6;animation:pulse 2s infinite}
    .playlist-item-info{flex:1;overflow:hidden}
    .playlist-item-title{font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:14px;margin-bottom:3px}
    .playlist-item-artist{font-size:12px;color:#aaa;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .remove-from-playlist{background:none;border:none;color:#aaa;cursor:pointer;margin-left:10px;font-size:16px;transition:color .2s;width:24px;height:24px;display:flex;align-items:center;justify-content:center;border-radius:50%}
    .remove-from-playlist:hover{color:#ff4d4d;background:rgba(255,77,77,.1)}

    .container{
      flex:1;background:rgba(30,22,45,.85);border-radius:16px;padding:25px;backdrop-filter:blur(10px);
      box-shadow:0 12px 30px rgba(0,0,0,.6);border:1px solid rgba(255,255,255,.12);display:flex;flex-direction:column;animation:slideInRight .6s ease-out;
    }
    h1{ text-align:center;margin-bottom:25px;color:#9b59b6;font-size:32px;font-weight:800;text-shadow:0 2px 10px rgba(155,89,182,.3);letter-spacing:1px;position:relative;padding-bottom:15px;}
    h1::after{content:'';position:absolute;bottom:0;left:50%;transform:translateX(-50%);width:100px;height:3px;background:linear-gradient(90deg,transparent,#9b59b6,transparent);border-radius:3px}

    .search-container{display:flex;margin-bottom:20px;position:relative}
    .search-input{
      flex:1;padding:14px 20px;border:none;border-radius:30px 0 0 30px;font-size:16px;background:rgba(255,255,255,.08);color:#fff;outline:none;transition:all .3s;font-weight:500;
    }
    .search-button{
      padding:14px 25px;background:linear-gradient(135deg,#8e44ad,#9b59b6);color:#fff;border:none;border-radius:0 30px 30px 0;cursor:pointer;font-size:16px;transition:all .3s;font-weight:600;
    }

    /* === æœç´¢ç»“æœï¼ˆä¿æŒç®€å•ï¼Œæ— æŠ˜å ï¼‰ === */
    .search-results{
      max-height:200px;overflow-y:auto;margin-bottom:20px;border-radius:12px;background:rgba(0,0,0,.25);border:1px solid rgba(255,255,255,.1);
    }
    .result-item{
      padding:16px;border-bottom:1px solid rgba(255,255,255,.08);cursor:pointer;transition:all .2s;display:flex;justify-content:space-between;align-items:center;animation:fadeIn .4s ease;
    }
    .result-item:hover{background:rgba(255,255,255,.1)}
    .result-item.active{background:linear-gradient(90deg,rgba(155,89,182,.15),rgba(155,89,182,.05))}
    .song-info{flex:1}
    .song-title{font-weight:600;margin-bottom:6px;color:#fff;font-size:15px}
    .song-artist,.song-album{font-size:13px;color:#aaa}
    .add-to-playlist{
      background:none;border:none;color:#9b59b6;cursor:pointer;font-size:22px;margin-left:10px;width:36px;height:36px;display:flex;align-items:center;justify-content:center;border-radius:50%;
      transition:all .2s;
    }
    .add-to-playlist:hover{background:rgba(155,89,182,.15);transform:scale(1.1)}

    .pagination{display:flex;justify-content:center;margin-top:15px;gap:12px}
    .page-button{padding:8px 16px;background:rgba(255,255,255,.1);border:none;border-radius:8px;color:#fff;cursor:pointer;font-weight:500;transition:all .2s}
    .page-button.active{background:linear-gradient(135deg,#8e44ad,#9b59b6)}
    .page-button:disabled{opacity:.5;cursor:not-allowed}

    .player-container{display:flex;flex:1;margin-top:20px;gap:25px;min-height:400px}
    .player-left{width:280px;display:flex;flex-direction:column}
    .album-art-container{
      position:relative;width:100%;border-radius:12px;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,.5);margin-bottom:25px;perspective:1000px;transform-style:preserve-3d;transition:transform .5s ease;
    }
    .album-art-wrapper{width:100%;height:0;padding-bottom:100%;position:relative}
    .album-art{position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;transition:transform .5s ease;border-radius:12px}
    .album-art-container:hover .album-art{transform:scale(1.05)}
    .album-art-overlay{position:absolute;bottom:0;left:0;right:0;background:linear-gradient(transparent,rgba(0,0,0,.7));padding:15px;text-align:center}
    .player-info{text-align:center;margin-bottom:25px;width:100%}
    .now-playing-title{font-size:22px;font-weight:700;margin-bottom:8px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .now-playing-artist{font-size:16px;color:#aaa;margin-bottom:5px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .now-playing-album{font-size:14px;color:#777;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    .progress-container{width:100%;margin-bottom:20px}
    .progress-bar{width:100%;height:6px;background:rgba(255,255,255,.15);border-radius:3px;cursor:pointer;margin-bottom:8px;overflow:hidden}
    .progress{height:100%;background:linear-gradient(90deg,#8e44ad,#9b59b6);border-radius:3px;width:0%;position:relative;transition:width .1s linear}
    .progress::after{content:'';position:absolute;top:0;right:0;width:12px;height:12px;background:#fff;border-radius:50%;transform:translate(50%,-25%);box-shadow:0 0 10px rgba(155,89,182,.8);opacity:0;transition:opacity .2s}
    .progress-bar:hover .progress::after{opacity:1}
    .time-info{display:flex;justify-content:space-between;font-size:13px;color:#aaa}

    .controls{display:flex;justify-content:center;align-items:center;gap:20px;margin-bottom:20px;position:relative}
    .control-button{
      background:rgba(255,255,255,.08);border:none;color:#fff;font-size:22px;cursor:pointer;width:45px;height:45px;display:flex;align-items:center;justify-content:center;border-radius:50%;
      transition:all .3s;box-shadow:0 4px 10px rgba(0,0,0,.2);
    }
    .control-button:hover{background:rgba(255,255,255,.15);transform:translateY(-2px)}
    .play-button{background:linear-gradient(135deg,#8e44ad,#9b59b6);width:60px;height:60px;font-size:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;box-shadow:0 6px 20px rgba(155,89,182,.4);transition:all .3s}
    .play-button:hover{background:linear-gradient(135deg,#9b59b6,#8e44ad);transform:scale(1.05)}
    .volume-container{display:flex;align-items:center;gap:10px;margin-left:20px;background:rgba(255,255,255,.08);padding:8px 15px;border-radius:30px}
    .volume-icon{font-size:18px;color:#aaa}
    .volume-slider{width:90px;-webkit-appearance:none;height:5px;background:rgba(255,255,255,.15);border-radius:5px;outline:none}
    .volume-slider::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;width:14px;height:14px;border-radius:50%;background:#9b59b6;cursor:pointer;box-shadow:0 0 8px rgba(155,89,182,.8);transition:all .2s}
    .play-mode-btn{background:none;border:none;color:#aaa;font-size:18px;cursor:pointer;margin-left:10px;width:36px;height:36px;display:flex;align-items:center;justify-content:center;border-radius:50%;transition:all .3s}
    .play-mode-btn:hover{background:rgba(255,255,255,.1);color:#9b59b6}

    .lyrics-container{
      flex:1;overflow-y:auto;scroll-behavior:smooth;padding:20px;background:rgba(0,0,0,.2);border-radius:12px;margin-left:20px;position:relative;min-height:300px;max-height:50vh;transition:all .3s ease;
    }
    .lyrics-content{text-align:center;transition:transform .1s ease-out;padding:20px 0}
    .lyric-line{margin:16px 0;color:rgba(255,255,255,.7);font-size:18px;line-height:1.7;transition:all .3s;min-height:28px;font-weight:300;opacity:.8;cursor:pointer}
    .lyric-line.active{color:#fff;font-size:22px;font-weight:600;opacity:1;text-shadow:0 0 10px rgba(255,255,255,.3);transition:all .1s ease}
    .lyric-line.translation{color:rgba(170,170,170,.8);font-size:16px;margin-top:-10px;margin-bottom:20px;min-height:22px;font-style:italic}
    .no-lyrics{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:#666;font-size:18px;font-style:italic}

    .loading{display:none;text-align:center;padding:25px;color:#aaa;font-size:18px}
    .loading.active{display:block}
    .loading::after{content:'...';animation:loadingDots 1.5s infinite}
    .error{color:#ff6b6b;text-align:center;padding:12px;display:none;background:rgba(255,77,77,.1);border-radius:8px;margin-bottom:15px;font-weight:500;animation:shake .5s}
    .error.active{display:block}

    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    @keyframes slideInLeft{from{opacity:0;transform:translateX(-20px)}to{opacity:1;transform:translateX(0)}}
    @keyframes slideInRight{from{opacity:0;transform:translateX(20px)}to{opacity:1;transform:translateX(0)}}
    @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(155,89,182,.4)}70%{box-shadow:0 0 0 10px rgba(155,89,182,0)}100%{box-shadow:0 0 0 0 rgba(155,89,182,0)}}

    /* ç§»åŠ¨ç«¯ */
    @media (max-width:768px){
      .main-wrapper{flex-direction:column;gap:15px}
      .playlist-container,.container{width:100%;max-width:100%}
      .player-container{flex-direction:column;min-height:auto}
      .player-left{width:100%;align-items:center}
      .lyrics-container{margin-left:0;margin-top:25px;min-height:250px;max-height:40vh}
      .control-button,.play-button{width:55px;height:55px;font-size:24px}
      .play-button{width:70px;height:70px}
      .search-container{flex-direction:column}
      .search-input{border-radius:30px;margin-bottom:10px}
      .search-button{border-radius:30px;width:100%}
      .share-music{bottom:70px}
      .desktop-lyrics-btn{display:none!important}
      .top-info-content{flex-direction:column;gap:4px;padding:0 15px}
      .main-wrapper{margin-top:60px}
    }
  </style>
</head>
<body>
  <div class="top-info-bar">
    <div class="top-info-content">
      <span>Â©HarmoniaéŸ³ä¹æ’­æ”¾å™¨(2024-2025) ç‰ˆæƒå½’Harmoniaå›¢é˜Ÿæ‰€æœ‰ ä¸¥ç¦å€’å–/å•†ä¸šè¡Œä¸º</span>
      <a href="tiaokuan.html" class="top-terms-link">ç‚¹å‡»è·³è½¬éšç§æ”¿ç­–ä»¥åŠç”¨æˆ·æ¡æ¬¾</a>
    </div>
  </div>

  <!-- æ‚¬æµ®æŒ‰é’® -->
  <button class="desktop-lyrics-btn" id="desktopLyricsBtn">å¼€å¯æ¡Œé¢æ­Œè¯ï¼ˆæ¡Œé¢ç«¯é™å®šï¼‰</button>
  <div class="desktop-lyrics-status" id="desktopLyricsStatus">æœªè¿æ¥æ¡Œé¢æ­Œè¯ç¨‹åº</div>
  <button class="share-music" id="shareMusicBtn"><span class="button-text">å‘ç°äº†å®è—æ­Œæ›²æƒ³åˆ†äº«ï¼Ÿç‚¹æˆ‘ï¼</span><span class="mobile-text" style="display:none">åˆ†äº«æ­Œæ›²</span></button>
  <button class="save-wallpaper" id="saveWallpaperBtn">å£çº¸å¥½çœ‹å—ï¼Ÿç‚¹æˆ‘ç«‹å³ä¿å­˜ï¼</button>
  <div class="theme-toggle" id="themeToggle"><i class="fas fa-moon"></i></div>

  <div class="main-wrapper">
    <!-- å·¦ä¾§ï¼šåˆ—è¡¨ï¼ˆæ”¯æŒæŠ˜å ï¼‰ -->
    <div class="playlist-container">
      <div class="playlist-tabs">
        <div class="playlist-tab active" data-tab="playlist">æ’­æ”¾åˆ—è¡¨</div>
        <div class="playlist-tab" data-tab="favorites">æˆ‘çš„æ”¶è—</div>
        <div class="playlist-tab" data-tab="history">æ’­æ”¾å†å²</div>
      </div>
      <div class="playlist-header">
        <div class="playlist-title" id="playlistTitle">æ’­æ”¾åˆ—è¡¨</div>
        <div class="header-actions">
          <button class="clear-playlist" id="clearPlaylist">æ¸…ç©º</button>
          <!-- æŠ˜å æŒ‰é’® -->
          <button class="collapse-toggle" id="collapsePlaylist" aria-expanded="true" title="æ”¶èµ·åˆ—è¡¨">
            <i class="fas fa-chevron-up"></i>
          </button>
        </div>
      </div>
      <!-- æŠ˜å åŒ…è£¹å±‚ -->
      <div class="playlist-collapsible" id="playlistCollapsible">
        <div class="playlist-items" id="playlistItems"></div>
      </div>
    </div>

    <!-- å³ä¾§ï¼šä¸»å®¹å™¨ -->
    <div class="container">
      <h1>Harmonia - éŸ³ä¹æ’­æ”¾å™¨</h1>

      <div class="search-container">
        <input type="text" class="search-input" id="searchInput" placeholder="æœç´¢æ­Œæ›²ã€æ­Œæ‰‹æˆ–ä¸“è¾‘..." autocomplete="off" />
        <button class="search-button" id="searchButton">æœç´¢</button>
      </div>

      <div class="error" id="errorMessage"></div>
      <div class="loading" id="loadingIndicator">åŠ è½½ä¸­</div>

      <!-- æœç´¢ç»“æœï¼šä¿æŒç®€å•ï¼Œæ— æŠ˜å  -->
      <div class="search-results" id="searchResults"></div>

      <div class="pagination" id="pagination"></div>

      <div class="player-container" id="playerContainer" style="display:none;">
        <div class="player-left">
          <div class="album-art-container" id="albumArtContainer">
            <div class="album-art-wrapper">
              <img src="https://picsum.photos/500" alt="ä¸“è¾‘å°é¢" class="album-art" id="albumArt" />
            </div>
            <div class="album-art-overlay">
              <div class="now-playing-title" id="nowPlayingTitle">æ­Œæ›²æ ‡é¢˜</div>
              <div class="now-playing-artist" id="nowPlayingArtist">æ­Œæ‰‹</div>
            </div>
          </div>

          <div class="player-info">
            <div class="now-playing-album" id="nowPlayingAlbum">ä¸“è¾‘</div>
          </div>

          <div class="progress-container">
            <div class="progress-bar" id="progressBar">
              <div class="progress" id="progress"></div>
            </div>
            <div class="time-info">
              <span id="currentTime">0:00</span>
              <span id="duration">0:00</span>
            </div>
          </div>

          <div class="controls">
            <button class="control-button" id="prevButton">â®</button>
            <button class="control-button play-button" id="playButton">â–¶</button>
            <button class="control-button" id="nextButton">â­</button>
            <button class="play-mode-btn" id="playModeBtn" title="å¾ªç¯æ’­æ”¾"><i class="fas fa-redo"></i></button>
            <div class="volume-container">
              <span class="volume-icon">ğŸ”Š</span>
              <input type="range" class="volume-slider" id="volumeSlider" min="0" max="1" step="0.01" value="0.7" />
            </div>
          </div>
        </div>

        <div class="lyrics-container">
          <div class="lyrics-content" id="lyricsContent">
            <div class="no-lyrics">æš‚æ— æ­Œè¯</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <audio id="audioPlayer"></audio>

  <script>
    // ===== DOM =====
    const searchInput = document.getElementById('searchInput');
    const searchButton = document.getElementById('searchButton');
    const searchResults = document.getElementById('searchResults');
    const playerContainer = document.getElementById('playerContainer');
    const albumArt = document.getElementById('albumArt');
    const albumArtContainer = document.getElementById('albumArtContainer');
    const nowPlayingTitle = document.getElementById('nowPlayingTitle');
    const nowPlayingArtist = document.getElementById('nowPlayingArtist');
    const nowPlayingAlbum = document.getElementById('nowPlayingAlbum');
    const progressBar = document.getElementById('progressBar');
    const progress = document.getElementById('progress');
    const currentTimeDisplay = document.getElementById('currentTime');
    const durationDisplay = document.getElementById('duration');
    const playButton = document.getElementById('playButton');
    const prevButton = document.getElementById('prevButton');
    const nextButton = document.getElementById('nextButton');
    const audioPlayer = document.getElementById('audioPlayer');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const errorMessage = document.getElementById('errorMessage');
    const pagination = document.getElementById('pagination');
    const volumeSlider = document.getElementById('volumeSlider');
    const playlistItems = document.getElementById('playlistItems');
    const clearPlaylist = document.getElementById('clearPlaylist');
    const saveWallpaperBtn = document.getElementById('saveWallpaperBtn');
    const lyricsContent = document.getElementById('lyricsContent');
    const shareMusicBtn = document.getElementById('shareMusicBtn');
    const desktopLyricsBtn = document.getElementById('desktopLyricsBtn');
    const desktopLyricsStatus = document.getElementById('desktopLyricsStatus');
    const themeToggle = document.getElementById('themeToggle');
    const playlistTabs = document.querySelectorAll('.playlist-tab');
    const playlistTitle = document.getElementById('playlistTitle');
    const playModeBtn = document.getElementById('playModeBtn');
    const collapsePlaylistBtn = document.getElementById('collapsePlaylist');
    const playlistCollapsible = document.getElementById('playlistCollapsible');
    const originalTitle = "Harmonia - éŸ³ä¹æ’­æ”¾å™¨";

    // ===== State =====
    let currentPage = 1;
    let currentSearchResults = [];
    let currentTrackIndex = -1;
    let playlist = JSON.parse(localStorage.getItem('musicPlaylist')) || [];
    let favorites = JSON.parse(localStorage.getItem('musicFavorites')) || [];
    let history = JSON.parse(localStorage.getItem('musicHistory')) || [];
    let currentPlaylistIndex = -1;
    let currentWallpaperUrl = '';
    let lyricsData = [];
    let isPlaying = false;
    let isLyricTitleActive = false;
    let ws = null;
    let desktopLyricsEnabled = false;
    let currentLyricsResponse = null;
    let currentPlayMode = 'normal'; // normal, repeat, shuffle
    let currentTab = 'playlist';

    audioPlayer.volume = volumeSlider.value;

    // ===== Utils & UI =====
    function clearError(){ errorMessage.classList.remove('active'); }
    function showError(msg, duration=3000){ errorMessage.textContent = msg; errorMessage.classList.add('active'); if(duration){ setTimeout(()=>errorMessage.classList.remove('active'), duration); } }
    function isMobile(){ return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent); }
    function optimizeMobileButtons(){
      if(isMobile()){
        desktopLyricsBtn.style.display='none';
        desktopLyricsStatus.style.display='none';
        shareMusicBtn.textContent='åˆ†äº«æ­Œæ›²';
        saveWallpaperBtn.textContent='ä¿å­˜å£çº¸';
      }
    }

    function initTheme(){
      const saved = localStorage.getItem('musicPlayerTheme') || 'dark';
      if(saved==='light'){ document.body.classList.add('light-theme'); themeToggle.innerHTML='<i class="fas fa-sun"></i>'; }
      else { document.body.classList.remove('light-theme'); themeToggle.innerHTML='<i class="fas fa-moon"></i>'; }
    }
    function toggleTheme(){
      if(document.body.classList.contains('light-theme')){ document.body.classList.remove('light-theme'); localStorage.setItem('musicPlayerTheme','dark'); themeToggle.innerHTML='<i class="fas fa-moon"></i>'; }
      else { document.body.classList.add('light-theme'); localStorage.setItem('musicPlayerTheme','light'); themeToggle.innerHTML='<i class="fas fa-sun"></i>'; }
    }

    function updatePageTitle(){
      const titleEl = document.querySelector('title');
      if(isPlaying && nowPlayingTitle.textContent && nowPlayingArtist.textContent){
        titleEl.textContent = `æ­£åœ¨ä¸ºæ‚¨æ’­æ”¾ï¼šã€Š${nowPlayingTitle.textContent}ã€‹â€”â€”${nowPlayingArtist.textContent}`;
      }else{
        titleEl.textContent = originalTitle;
      }
      isLyricTitleActive = false;
    }

    // ===== Lyrics =====
    function parseLyrics(lyricText){
      if(!lyricText) return [];
      const lines = lyricText.split('\n'); const res=[];
      const re=/\[(\d{2}):(\d{2})\.(\d{2,3})\]/;
      for(const line of lines){
        const m=re.exec(line);
        if(m){ const min=parseInt(m[1]); const sec=parseInt(m[2]); const ms=parseInt(m[3]);
          const t = min*60 + sec + ms/(m[3].length===2?100:1000);
          const txt=line.replace(re,'').trim();
          if(txt) res.push({time:t,text:txt});
        }
      }
      return res;
    }

    function displayLyrics(lyricResponse){
      lyricsContent.innerHTML='';
      if(!lyricResponse || (!lyricResponse.lyric && !lyricResponse.tlyric)){
        lyricsContent.innerHTML='<div class="no-lyrics">æš‚æ— æ­Œè¯</div>'; lyricsData=[]; return;
      }
      const main = lyricResponse.lyric ? parseLyrics(lyricResponse.lyric) : [];
      const hasTrans = lyricResponse.tlyric && lyricResponse.tlyric.trim()!=='';
      const trans = hasTrans ? parseLyrics(lyricResponse.tlyric) : [];
      lyricsData = hasTrans
        ? main.map(m=>{
            const t = trans.find(T=>Math.abs(T.time-m.time)<0.1);
            return {time:m.time,text:m.text,translation:t?t.text:''};
          })
        : main.map(m=>({time:m.time,text:m.text,translation:''}));

      lyricsData.forEach(line=>{
        const l=document.createElement('div'); l.className='lyric-line'; l.textContent=line.text; l.dataset.time=line.time; l.style.minHeight='24px'; lyricsContent.appendChild(l);
        if(line.translation && line.translation.trim()!==''){
          const tl=document.createElement('div'); tl.className='lyric-line translation'; tl.textContent=line.translation; tl.dataset.time=line.time; tl.style.minHeight='20px'; lyricsContent.appendChild(tl);
        }
      });
      currentLyricsResponse = lyricResponse;
    }

    function scrollToLyricLine(el){
      if(!el) return;
      const c=document.querySelector('.lyrics-container');
      const ch=c.clientHeight, ct=c.getBoundingClientRect().top, lt=el.getBoundingClientRect().top, lh=el.clientHeight;
      const offset = (lt-ct) - (ch/2) + (lh/2);
      c.scrollTo({ top: c.scrollTop + offset, behavior:'smooth' });
    }

    // å°†å½“å‰è¡Œæ­Œè¯å‘é€åˆ°æ¡Œé¢æ­Œè¯ç¨‹åºï¼ˆè¡¥å……å‡½æ•°ï¼‰
    function sendLyricToDesktop(text){
      if(!desktopLyricsEnabled || !ws || ws.readyState !== WebSocket.OPEN) return;
      try{ ws.send(JSON.stringify({type:'lyric', text: text || ''})); }catch(e){}
    }

    function updateLyricsHighlight(currentTime){
      if(!lyricsData.length){ updatePageTitle(); return; }
      let activeIndex=-1;
      for(let i=0;i<lyricsData.length;i++){ if(lyricsData[i].time<=currentTime) activeIndex=i; else break; }
      const all = lyricsContent.querySelectorAll('.lyric-line:not(.translation)');
      all.forEach((line,idx)=>{
        line.classList.remove('active');
        if(idx===activeIndex){
          line.classList.add('active'); scrollToLyricLine(line);
          const lyricText = lyricsData[idx].text;
          if(lyricText && lyricText.trim()!==''){ document.title = lyricText; isLyricTitleActive = true; sendLyricToDesktop(lyricText); }
        }
      });
      if(activeIndex===-1 && isLyricTitleActive){ updatePageTitle(); isLyricTitleActive=false; sendLyricToDesktop(""); }
    }

    // ===== Playlist =====
    function initPlaylist(){ renderPlaylist(); }
    function renderPlaylist(){
      playlistItems.innerHTML='';
      let items=[];
      if(currentTab==='playlist'){ items=playlist; playlistTitle.textContent='æ’­æ”¾åˆ—è¡¨'; }
      else if(currentTab==='favorites'){ items=favorites; playlistTitle.textContent='æˆ‘çš„æ”¶è—'; }
      else { items=[...history].reverse(); playlistTitle.textContent='æ’­æ”¾å†å²'; }

      if(items.length===0){
        playlistItems.innerHTML=`<div style="padding:15px;color:#aaa;text-align:center;font-style:italic;">
          ${currentTab==='favorites'?'æ”¶è—åˆ—è¡¨ä¸ºç©º':currentTab==='history'?'æš‚æ— æ’­æ”¾å†å²':'æ’­æ”¾åˆ—è¡¨ä¸ºç©º'}</div>`;
        return;
      }

      items.forEach((it,idx)=>{
        const d=document.createElement('div'); d.className='playlist-item';
        if(currentTab==='playlist' && idx===currentPlaylistIndex) d.classList.add('active');
        const extra = currentTab==='history' ? `<div class="playlist-item-time" style="font-size:11px;color:#777;margin-top:3px;">${formatDate(it.timestamp)}</div>` : '';
        d.innerHTML=`
          <div class="playlist-item-info">
            <div class="playlist-item-title">${it.name||'æœªçŸ¥æ­Œæ›²'}</div>
            <div class="playlist-item-artist">${Array.isArray(it.artist)?it.artist.join('ã€'):(it.artist||'æœªçŸ¥æ­Œæ‰‹')}</div>
            ${extra}
          </div>
          ${currentTab==='playlist'?`<button class="remove-from-playlist" data-index="${idx}">Ã—</button>`:''}
        `;
        d.addEventListener('click',()=>{
          if(currentTab==='playlist'){ playFromPlaylist(idx); }
          else { playTrackFromItem(it); }
        });
        playlistItems.appendChild(d);
      });

      if(currentTab==='playlist'){
        document.querySelectorAll('.remove-from-playlist').forEach(btn=>{
          btn.addEventListener('click',e=>{
            e.stopPropagation(); const i=parseInt(btn.getAttribute('data-index')); removeFromPlaylist(i);
          });
        });
      }
    }
    function formatDate(ts){ const d=new Date(ts); return `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`; }
    function savePlaylist(){ localStorage.setItem('musicPlaylist', JSON.stringify(playlist)); }
    function addToPlaylist(track){
      const exists = playlist.some(x=>x.id===track.id);
      if(!exists){ playlist.push(track); savePlaylist(); renderPlaylist(); }
    }
    function addToFavorites(track){
      const exists = favorites.some(x=>x.id===track.id);
      if(!exists){ favorites.push(track); localStorage.setItem('musicFavorites', JSON.stringify(favorites)); if(currentTab==='favorites') renderPlaylist(); showError('å·²æ·»åŠ åˆ°æ”¶è—',1500); }
    }
    function addToHistory(track){
      const i = history.findIndex(x=>x.id===track.id);
      if(i!==-1){ history[i].timestamp = Date.now(); }
      else{ track.timestamp=Date.now(); history.push(track); if(history.length>50) history.shift(); }
      localStorage.setItem('musicHistory', JSON.stringify(history));
      if(currentTab==='history') renderPlaylist();
    }
    function removeFromPlaylist(index){
      playlist.splice(index,1);
      if(currentPlaylistIndex===index){ currentPlaylistIndex=-1; audioPlayer.pause(); playerContainer.style.display='none'; }
      else if(currentPlaylistIndex>index){ currentPlaylistIndex--; }
      savePlaylist(); renderPlaylist();
    }
    function clearPlaylistItems(){
      if(currentTab==='playlist'){ playlist=[]; savePlaylist(); }
      else if(currentTab==='favorites'){ favorites=[]; localStorage.setItem('musicFavorites', JSON.stringify(favorites)); }
      else { history=[]; localStorage.setItem('musicHistory', JSON.stringify(history)); }
      currentPlaylistIndex=-1; audioPlayer.pause(); playerContainer.style.display='none'; renderPlaylist();
    }

    // ===== Network (music api) =====
    async function fetchLyrics(lyricId){
      try{
        const r = await fetch(`https://music-api.gdstudio.xyz/api.php?types=lyric&source=netease&id=${lyricId}`);
        if(!r.ok) throw new Error('æ— æ³•è·å–æ­Œè¯');
        return await r.json();
      }catch(e){ console.error(e); return null; }
    }
    async function getAlbumArtUrl(picId){
      try{
        const r = await fetch(`https://music-api.gdstudio.xyz/api.php?types=pic&source=netease&id=${picId}&size=500`);
        if(!r.ok) throw new Error('æ— æ³•è·å–ä¸“è¾‘å›¾ç‰‡');
        const data = await r.json(); if(!data.url) throw new Error('æ— æ•ˆçš„ä¸“è¾‘å›¾ç‰‡URL');
        return data.url.replace(/\\/g,'');
      }catch(e){ console.error(e); return null; }
    }
    async function loadAlbumArt(picId){
      const url = await getAlbumArtUrl(picId);
      if(url){ albumArt.src=url; albumArt.style.opacity=0; setTimeout(()=>{ albumArt.style.transition='opacity .5s'; albumArt.style.opacity=1; },10); }
      else { albumArt.src=''; }
    }
    async function getAudioUrl(id){
      try{
        const r = await fetch(`https://music-api.gdstudio.xyz/api.php?types=url&source=netease&id=${id}&br=999`);
        const data=await r.json(); if(!data.url) throw new Error('æ— æ³•è·å–éŸ³é¢‘é“¾æ¥');
        return data.url.replace(/\\/g,'');
      }catch(e){ console.error(e); return null; }
    }
    async function getRandomBackground(){
      try{
        const types=['wallpaper','acg']; const tp=types[Math.floor(Math.random()*types.length)];
        const r = await fetch(`https://v2.xxapi.cn/api/random4kPic?type=${tp}`);
        if(!r.ok) throw new Error('æ— æ³•è·å–èƒŒæ™¯å›¾ç‰‡'); const data=await r.json(); return data.data;
      }catch(e){ console.error(e); return null; }
    }
    async function updateBackground(){
      const url = await getRandomBackground();
      if(url){ document.body.style.backgroundImage=`url(${url})`; currentWallpaperUrl=url; saveWallpaperBtn.style.display='block'; }
    }

    // ===== Search / Play =====
    async function searchMusic(query, page=1){
      if(!query.trim()){ showError('è¯·è¾“å…¥æœç´¢å†…å®¹'); return; }
      try{
        showLoading(); clearError();
        const r = await fetch(`https://music-api.gdstudio.xyz/api.php?types=search&source=netease&name=${encodeURIComponent(query)}&count=20&pages=${page}`);
        if(!r.ok) throw new Error('æœç´¢å¤±è´¥ï¼Œè¯·ç¨åå†è¯•');
        const data = await r.json();
        if(!data || data.length===0) throw new Error('æœªæ‰¾åˆ°ç›¸å…³æ­Œæ›²');
        currentSearchResults = data; displaySearchResults(data); updatePagination(page);
      }catch(e){ showError(e.message); }
      finally{ hideLoading(); }
    }
    function displaySearchResults(results){
      searchResults.innerHTML='';
      if(results.length===0){ searchResults.innerHTML='<div class="result-item">æœªæ‰¾åˆ°ç›¸å…³æ­Œæ›²</div>'; return; }
      results.forEach((song,idx)=>{
        const item=document.createElement('div'); item.className='result-item'; if(idx===currentTrackIndex) item.classList.add('active');
        const artists = Array.isArray(song.artist) ? song.artist.join('ã€') : (song.artist||'æœªçŸ¥æ­Œæ‰‹');
        item.innerHTML=`
          <div class="song-info">
            <div class="song-title">${song.name || 'æœªçŸ¥æ­Œæ›²'}</div>
            <div class="song-artist">${artists}</div>
            <div class="song-album">${song.album || 'æœªçŸ¥ä¸“è¾‘'}</div>
          </div>
          <div>
            <button class="add-to-playlist" data-index="${idx}" title="æ·»åŠ åˆ°æ’­æ”¾åˆ—è¡¨">+</button>
            <button class="add-to-favorites" data-index="${idx}" title="æ·»åŠ åˆ°æ”¶è—"><i class="fas fa-heart"></i></button>
          </div>`;
        item.addEventListener('click',()=>playTrack(idx));
        const addBtn = item.querySelector('.add-to-playlist');
        addBtn.addEventListener('click',e=>{ e.stopPropagation(); addToPlaylist(currentSearchResults[parseInt(addBtn.dataset.index)]); });
        const favBtn = item.querySelector('.add-to-favorites');
        favBtn.addEventListener('click',e=>{
          e.stopPropagation(); addToFavorites(currentSearchResults[parseInt(favBtn.dataset.index)]);
          favBtn.innerHTML='<i class="fas fa-check"></i>'; setTimeout(()=>{ favBtn.innerHTML='<i class="fas fa-heart"></i>'; }, 1000);
        });
        searchResults.appendChild(item);
      });
    }
    function updatePagination(cur){
      pagination.innerHTML='';
      const prev=document.createElement('button'); prev.className='page-button'; prev.textContent='ä¸Šä¸€é¡µ'; prev.disabled=cur<=1;
      prev.addEventListener('click',()=>{ if(cur>1) searchMusic(searchInput.value.trim(), cur-1); });
      const info=document.createElement('span'); info.className='page-button'; info.textContent=`ç¬¬ ${cur} é¡µ`;
      const next=document.createElement('button'); next.className='page-button'; next.textContent='ä¸‹ä¸€é¡µ';
      next.addEventListener('click',()=>{ searchMusic(searchInput.value.trim(), cur+1); });
      pagination.appendChild(prev); pagination.appendChild(info); pagination.appendChild(next);
    }

    async function playFromPlaylist(index){
      if(index<0 || index>=playlist.length) return;
      try{
        showLoading(); clearError();
        const t = playlist[index]; currentPlaylistIndex=index; currentTrackIndex=-1;
        nowPlayingTitle.textContent=t.name||'æœªçŸ¥æ­Œæ›²';
        nowPlayingArtist.textContent=Array.isArray(t.artist)?t.artist.join('ã€'): (t.artist||'æœªçŸ¥æ­Œæ‰‹');
        nowPlayingAlbum.textContent=t.album||'æœªçŸ¥ä¸“è¾‘';
        sendSongInfoToDesktop(); await loadAlbumArt(t.pic_id);
        const lyr=await fetchLyrics(t.lyric_id); displayLyrics(lyr); sendFullLyricsToDesktop(lyr);
        const url = await getAudioUrl(t.id);
        if(url){
          audioPlayer.src=url; playerContainer.style.display='flex';
          await audioPlayer.play().then(()=>{ playButton.textContent='â¸'; renderPlaylist(); addToHistory(t); })
            .catch(e=>{ if(isMobile()) showError('è¯·ç‚¹å‡»æ’­æ”¾æŒ‰é’®ç¡®è®¤æ’­æ”¾'); else showError('æ’­æ”¾å¤±è´¥: '+e.message); });
        }
        await updateBackground();
      }catch(e){ showError(e.message); }
      finally{ hideLoading(); }
      isPlaying=true; isLyricTitleActive=false; updatePageTitle();
    }

    async function playTrackFromItem(item){
      try{
        showLoading(); clearError();
        currentPlaylistIndex=-1; currentTrackIndex=-1;
        nowPlayingTitle.textContent=item.name||'æœªçŸ¥æ­Œæ›²';
        nowPlayingArtist.textContent=Array.isArray(item.artist)?item.artist.join('ã€'): (item.artist||'æœªçŸ¥æ­Œæ‰‹');
        nowPlayingAlbum.textContent=item.album||'æœªçŸ¥ä¸“è¾‘';
        sendSongInfoToDesktop(); await loadAlbumArt(item.pic_id);
        const lyr=await fetchLyrics(item.lyric_id); displayLyrics(lyr); sendFullLyricsToDesktop(lyr);
        const url=await getAudioUrl(item.id);
        if(url){
          audioPlayer.src=url; playerContainer.style.display='flex';
          await audioPlayer.play().then(()=>{ playButton.textContent='â¸'; addToHistory(item); })
            .catch(e=>{ if(isMobile()) showError('è¯·ç‚¹å‡»æ’­æ”¾æŒ‰é’®ç¡®è®¤æ’­æ”¾'); else showError('æ’­æ”¾å¤±è´¥: '+e.message); });
        }
        await updateBackground();
      }catch(e){ showError(e.message); }
      finally{ hideLoading(); }
      isPlaying=true; isLyricTitleActive=false; updatePageTitle();
    }

    async function playTrack(index){
      if(index<0 || index>=currentSearchResults.length) return;
      try{
        showLoading(); clearError();
        const t=currentSearchResults[index]; currentTrackIndex=index; currentPlaylistIndex=-1;
        document.querySelectorAll('.result-item').forEach((el,i)=>{ if(i===index) el.classList.add('active'); else el.classList.remove('active'); });
        nowPlayingTitle.textContent=t.name||'æœªçŸ¥æ­Œæ›²';
        const url=await getAudioUrl(t.id); if(!url) throw new Error('æ— æ³•è·å–éŸ³é¢‘é“¾æ¥');
        nowPlayingArtist.textContent=Array.isArray(t.artist)?t.artist.join('ã€'): (t.artist||'æœªçŸ¥æ­Œæ‰‹');
        nowPlayingAlbum.textContent=t.album||'æœªçŸ¥ä¸“è¾‘';
        sendSongInfoToDesktop(); await loadAlbumArt(t.pic_id);
        const lyr=await fetchLyrics(t.lyric_id); displayLyrics(lyr); sendFullLyricsToDesktop(lyr);
        await updateBackground();
        audioPlayer.src=url; playerContainer.style.display='flex';
        await audioPlayer.play().then(()=>{ playButton.textContent='â¸'; renderPlaylist(); addToHistory(t); })
          .catch(e=>{ if(isMobile()) showError('è¯·ç‚¹å‡»æ’­æ”¾æŒ‰é’®ç¡®è®¤æ’­æ”¾'); else showError('æ’­æ”¾å¤±è´¥: '+e.message); });
      }catch(e){ showError(e.message); }
      finally{ hideLoading(); }
      isPlaying=true; isLyricTitleActive=false; updatePageTitle();
    }

    // ===== Desktop lyrics (WebSocket) =====
    function sendSongInfoToDesktop(){
      if(!desktopLyricsEnabled || !ws || ws.readyState!==WebSocket.OPEN) return;
      try{ ws.send(JSON.stringify({type:'song', song:nowPlayingTitle.textContent||'æœªçŸ¥æ­Œæ›²', artist:nowPlayingArtist.textContent||'æœªçŸ¥æ­Œæ‰‹'})); }catch(e){}
    }
    function sendFullLyricsToDesktop(lyricsResponse){
      if(!desktopLyricsEnabled || !ws || ws.readyState!==WebSocket.OPEN || !lyricsResponse) return;
      try{ ws.send(JSON.stringify({type:'full_lyric', lyric:lyricsResponse.lyric||'', tlyric:lyricsResponse.tlyric||''})); }catch(e){}
    }
    function sendCurrentTimeToDesktop(t){
      if(!desktopLyricsEnabled || !ws || ws.readyState!==WebSocket.OPEN) return;
      try{ ws.send(JSON.stringify({type:'time', currentTime:t})); }catch(e){}
    }
    function connectToDesktopLyrics(){
      desktopLyricsStatus.style.display='block';
      if(ws) ws.close();
      ws=new WebSocket('ws://localhost:8765');
      ws.onopen=()=>{
        desktopLyricsStatus.textContent='å·²è¿æ¥åˆ°æ¡Œé¢æ­Œè¯ç¨‹åº';
        desktopLyricsStatus.classList.remove('disconnected'); desktopLyricsStatus.classList.add('connected'); desktopLyricsEnabled=true;
        if(nowPlayingTitle.textContent){ sendSongInfoToDesktop(); }
        if(currentLyricsResponse){ sendFullLyricsToDesktop(currentLyricsResponse); }
      };
      ws.onerror=()=>{ desktopLyricsStatus.textContent='è¿æ¥æ¡Œé¢æ­Œè¯å¤±è´¥'; desktopLyricsStatus.classList.add('disconnected'); desktopLyricsEnabled=false; };
      ws.onclose=()=>{ desktopLyricsStatus.textå†…å®¹='æ¡Œé¢æ­Œè¯è¿æ¥å·²æ–­å¼€'; desktopLyricsStatus.classList.remove('connected'); desktopLyricsStatus.classList.add('disconnected'); desktopLyricsEnabled=false; };
    }

    // ===== Events =====
    function showLoading(){ loadingIndicator.classList.add('active'); }
    function hideLoading(){ loadingIndicator.classList.remove('active'); }

    searchButton.addEventListener('click',()=>searchMusic(searchInput.value.trim()));
    searchInput.addEventListener('keypress',e=>{ if(e.key==='Enter') searchMusic(searchInput.value.trim()); });

    lyricsContent.addEventListener('click',e=>{
      const target=e.target.closest('.lyric-line'); if(!target) return;
      const t=parseFloat(target.dataset.time); if(isNaN(t)) return;
      try{
        audioPlayer.currentTime=t; updateLyricsHighlight(t);
        audioPlayer.play().then(()=>{ playButton.textContent='â¸'; isPlaying=true; updatePageTitle(); }).catch(()=>{});
      }catch(_){}
    });

    playButton.addEventListener('click',()=>{
      clearError();
      if(audioPlayer.paused){
        audioPlayer.play().catch(()=>{ if(isMobile()){ showError('è¯·ç‚¹å‡»æ­¤å¤„ç¡®è®¤æ’­æ”¾',1500); }});
        playButton.textContent='â¸'; isPlaying=true; updatePageTitle();
      }else{
        audioPlayer.pause(); playButton.textContent='â–¶'; isPlaying=false; updatePageTitle();
      }
    });
    prevButton.addEventListener('click',()=>{
      if(currentPlayMode==='shuffle'){
        if(currentTab==='playlist' && playlist.length>0){ playFromPlaylist(Math.floor(Math.random()*playlist.length)); }
        else if(currentSearchResults.length>0){ playTrack(Math.floor(Math.random()*currentSearchResults.length)); }
      }else{
        if(currentPlaylistIndex>0) playFromPlaylist(currentPlaylistIndex-1);
        else if(currentTrackIndex>0) playTrack(currentTrackIndex-1);
      }
    });
    nextButton.addEventListener('click',()=>{
      if(currentPlayMode==='shuffle'){
        if(currentTab==='playlist' && playlist.length>0){ playFromPlaylist(Math.floor(Math.random()*playlist.length)); }
        else if(currentSearchResults.length>0){ playTrack(Math.floor(Math.random()*currentSearchResults.length)); }
      }else{
        if(currentPlaylistIndex>=0 && currentPlaylistIndex<playlist.length-1) playFromPlaylist(currentPlaylistIndex+1);
        else if(currentTrackIndex<currentSearchResults.length-1) playTrack(currentTrackIndex+1);
      }
    });
    progressBar.addEventListener('click',e=>{
      const w=progressBar.clientWidth, x=e.offsetX, dur=audioPlayer.duration; if(dur) audioPlayer.currentTime=(x/w)*dur;
    });
    audioPlayer.addEventListener('timeupdate',()=>{ // å•ä¸€ç›‘å¬å™¨ï¼Œé¿å…é‡å¤ç»‘å®š
      const {currentTime,duration}=audioPlayer;
      if(duration){
        const p=(currentTime/duration)*100; progress.style.width=`${p}%`;
        currentTimeDisplay.textContent=formatTime(currentTime); durationDisplay.textContent=formatTime(duration);
        updateLyricsHighlight(currentTime); sendCurrentTimeToDesktop(currentTime);
      }
    });
    audioPlayer.addEventListener('ended',()=>{
      isPlaying=false; updatePageTitle(); playButton.textContent='â–¶';
      if(currentPlayMode==='repeat'){
        if(currentTab==='playlist' && currentPlaylistIndex>=0) playFromPlaylist(currentPlaylistIndex); else if(currentTrackIndex>=0) playTrack(currentTrackIndex);
      }else if(currentPlayMode==='shuffle'){
        if(currentTab==='playlist' && playlist.length>0) playFromPlaylist(Math.floor(Math.random()*playlist.length));
        else if(currentSearchResults.length>0) playTrack(Math.floor(Math.random()*currentSearchResults.length));
      }else{
        if(currentPlaylistIndex>=0 && currentPlaylistIndex<playlist.length-1) playFromPlaylist(currentPlaylistIndex+1);
        else if(currentTrackIndex<currentSearchResults.length-1) playTrack(currentTrackIndex+1);
      }
    });
    audioPlayer.addEventListener('loadedmetadata',()=>{ const {currentTime,duration}=audioPlayer; currentTimeDisplay.textContent=formatTime(currentTime); durationDisplay.textContent=formatTime(duration); });
    audioPlayer.addEventListener('play',()=>{ isPlaying=true; updatePageTitle(); });
    audioPlayer.addEventListener('pause',()=>{ isPlaying=false; updatePageTitle(); });

    function formatTime(sec){ const m=Math.floor(sec/60); const s=Math.floor(sec%60); return `${m}:${s<10?'0':''}${s}`; }
    volumeSlider.addEventListener('input',e=>{ audioPlayer.volume=e.target.value; });
    clearPlaylist.addEventListener('click', clearPlaylistItems);
    themeToggle.addEventListener('click', toggleTheme);
    playModeBtn.addEventListener('click', ()=>{
      const modes=['normal','repeat','shuffle'], icons=['fa-redo','fa-repeat','fa-random'], titles=['å¾ªç¯æ’­æ”¾','å•æ›²å¾ªç¯','éšæœºæ’­æ”¾'];
      const idx=modes.indexOf(currentPlayMode); const next=(idx+1)%modes.length; currentPlayMode=modes[next];
      playModeBtn.innerHTML=`<i class="fas ${icons[next]}"></i>`; playModeBtn.title=titles[next]; showError(`æ’­æ”¾æ¨¡å¼å·²åˆ‡æ¢ä¸º: ${titles[next]}`,1500);
    });
    desktopLyricsBtn.addEventListener('click',()=>{
      if(!desktopLyricsEnabled) connectToDesktopLyrics();
      else{ if(ws) ws.close(); desktopLyricsEnabled=false; desktopLyricsStatus.textContent='æ¡Œé¢æ­Œè¯å·²å…³é—­'; desktopLyricsStatus.classList.remove('connected','disconnected'); }
    });
    shareMusicBtn.addEventListener('click',()=>{
      if(playlist.length===0){ showError('æ’­æ”¾åˆ—è¡¨ä¸ºç©ºï¼Œæ— æ³•åˆ†äº«'); return; }
      createShareModal();
    });

    // æ ‡ç­¾é¡µ
    playlistTabs.forEach(tab=>{
      tab.addEventListener('click',()=>{
        playlistTabs.forEach(t=>t.classList.remove('active')); tab.classList.add('active');
        currentTab=tab.dataset.tab; renderPlaylist();
      });
    });

    // ä¸“è¾‘å°é¢ 3D
    albumArtContainer.addEventListener('mousemove',e=>{
      const rect=albumArtContainer.getBoundingClientRect(); const x=e.clientX-rect.left; const y=e.clientY-rect.top;
      const cx=rect.width/2, cy=rect.height/2; const ry=(x-cx)/10, rx=(cy-y)/10;
      albumArtContainer.style.transform=`perspective(1000px) rotateX(${rx}deg) rotateY(${ry}deg)`;
    });
    albumArtContainer.addEventListener('mouseleave',()=>{ albumArtContainer.style.transform='perspective(1000px) rotateX(0) rotateY(0)'; });

    // åˆ†äº«æ¨¡æ€æ¡†
    function createShareModal(){
      const overlay=document.createElement('div'); overlay.className='modal-overlay';
      Object.assign(overlay.style,{position:'fixed',top:'0',left:'0',width:'100%',height:'100%',backgroundColor:'rgba(0,0,0,.7)',zIndex:'1000',display:'flex',justifyContent:'center',alignItems:'center'});
      const box=document.createElement('div'); box.className='modal-content';
      Object.assign(box.style,{backgroundColor:'#282828',borderRadius:'15px',padding:'20px',width:'90%',maxWidth:'500px',maxHeight:'80vh',overflow:'auto'});
      const title=document.createElement('h2'); title.textContent='åˆ†äº«æ­Œæ›²'; Object.assign(title.style,{color:'#9b59b6',marginBottom:'20px',textAlign:'center'});
      const tip=document.createElement('p'); tip.textContent='é€‰æ‹©è¦åˆ†äº«çš„æ­Œæ›²ï¼ˆå¯å¤šé€‰ï¼‰ï¼Œç„¶åç‚¹å‡»"å¯¼å‡ºåˆ†äº«æ–‡ä»¶"æŒ‰é’®'; Object.assign(tip.style,{color:'#aaa',marginBottom:'20px',fontSize:'14px'});
      const list=document.createElement('div'); Object.assign(list.style,{marginBottom:'20px',maxHeight:'300px',overflowY:'auto'});
      playlist.forEach((song,idx)=>{
        const row=document.createElement('div'); Object.assign(row.style,{display:'flex',alignItems:'center',padding:'10px',marginBottom:'5px',backgroundColor:'rgba(0,0,0,.3)',borderRadius:'5px',cursor:'pointer'});
        const cb=document.createElement('input'); cb.type='checkbox'; cb.dataset.index=idx; cb.style.marginRight='10px';
        const info=document.createElement('div'); info.style.flex='1';
        const st=document.createElement('div'); st.textContent=song.name||'æœªçŸ¥æ­Œæ›²'; st.style.fontWeight='bold'; st.style.marginBottom='3px';
        const sa=document.createElement('div'); sa.textContent=Array.isArray(song.artist)?song.artist.join('ã€'):(song.artist||'æœªçŸ¥æ­Œæ‰‹'); sa.style.fontSize='12px'; sa.style.color='#aaa';
        info.appendChild(st); info.appendChild(sa); row.appendChild(cb); row.appendChild(info);
        row.addEventListener('click',e=>{ if(e.target!==cb) cb.checked=!cb.checked; }); list.appendChild(row);
      });
      const btns=document.createElement('div'); btns.style.display='flex'; btns.style.justifyContent='space-between';
      const btnExport=document.createElement('button'); btnExport.textContent='å¯¼å‡ºåˆ†äº«æ–‡ä»¶'; Object.assign(btnExport.style,{padding:'10px 15px',background:'#9b59b6',color:'#fff',border:'none',borderRadius:'25px',cursor:'pointer',flex:'1',marginRight:'10px'});
      const btnImport=document.createElement('button'); btnImport.textContent='å¯¼å…¥åˆ†äº«æ–‡ä»¶'; Object.assign(btnImport.style,{padding:'10px 15px',background:'#6c5ce7',color:'#fff',border:'none',borderRadius:'25px',cursor:'pointer',flex:'1'});
      const btnClose=document.createElement('button'); btnClose.textContent='å–æ¶ˆ'; Object.assign(btnClose.style,{padding:'10px 15px',background:'#ff4d4d',color:'#fff',border:'none',borderRadius:'25px',cursor:'pointer',marginTop:'10px',width:'100%'});
      btns.appendChild(btnExport); btns.appendChild(btnImport);
      box.appendChild(title); box.appendChild(tip); box.appendChild(list); box.appendChild(btns); box.appendChild(btnClose);
      overlay.appendChild(box); document.body.appendChild(overlay);

      btnExport.addEventListener('click',()=>{
        const selected=[...overlay.querySelectorAll('input[type="checkbox"]:checked')].map(cb=>playlist[parseInt(cb.dataset.index)]);
        if(selected.length===0){ showError('è¯·è‡³å°‘é€‰æ‹©ä¸€é¦–æ­Œæ›²'); return; }
        exportSongs(selected); document.body.removeChild(overlay);
      });
      btnImport.addEventListener('click',()=>{
        const input=document.createElement('input'); input.type='file'; input.accept='.json,.txt';
        input.addEventListener('change',e=>{
          const file=e.target.files[0]; if(!file) return;
          const reader=new FileReader();
          reader.onload=ev=>{
            try{
              const imported=JSON.parse(ev.target.result);
              if(Array.isArray(imported)){
                const add = imported.filter(x=>!playlist.some(y=>y.id===x.id));
                if(add.length>0){ playlist=[...playlist, ...add]; savePlaylist(); renderPlaylist(); showError(`æˆåŠŸå¯¼å…¥ ${add.length} é¦–æ­Œæ›²`); }
                else showError('æ²¡æœ‰æ–°æ­Œæ›²å¯ä»¥å¯¼å…¥');
              }else showError('æ— æ•ˆçš„åˆ†äº«æ–‡ä»¶');
            }catch{ showError('æ— æ³•è§£æåˆ†äº«æ–‡ä»¶'); }
          };
          reader.readAsText(file);
        });
        input.click(); document.body.removeChild(overlay);
      });
      btnClose.addEventListener('click',()=>document.body.removeChild(overlay));
      overlay.addEventListener('click',e=>{ if(e.target===overlay) document.body.removeChild(overlay); });
    }
    function exportSongs(songs){
      const data=JSON.stringify(songs,null,2); const blob=new Blob([data],{type:'application/json'});
      const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`HarmoniaéŸ³ä¹åˆ†äº«_${new Date().toLocaleDateString()}.json`;
      document.body.appendChild(a); a.click(); setTimeout(()=>{ document.body.removeChild(a); URL.revokeObjectURL(url); },100);
      const old=shareMusicBtn.textContent; shareMusicBtn.textContent=`å·²å¯¼å‡º ${songs.length} é¦–æ­Œæ›²ï¼`; setTimeout(()=>shareMusicBtn.textContent=old,2000);
    }

    // ===== æŠ˜å é€»è¾‘ï¼ˆä»…åˆ—è¡¨ï¼‰ =====
    function bindCollapsible(button, bodyEl, storageKey, expandLabel, collapseLabel){
      if(!button || !bodyEl) return;
      let collapsed = localStorage.getItem(storageKey) === '1';
      const apply = ()=>{
        const icon=button.querySelector('i');
        if(collapsed){
          bodyEl.classList.add('hidden'); button.setAttribute('aria-expanded','false'); button.title=expandLabel; if(icon) icon.style.transform='rotate(180deg)';
        }else{
          bodyEl.classList.remove('hidden'); button.setAttribute('aria-expanded','true'); button.title=collapseLabel; if(icon) icon.style.transform='rotate(0deg)';
        }
        localStorage.setItem(storageKey, collapsed ? '1':'0');
      };
      apply();
      button.addEventListener('click',()=>{ collapsed=!collapsed; apply(); });
    }

    // ===== Init =====
    function init(){
      initTheme(); updateBackground(); initPlaylist(); optimizeMobileButtons();
      bindCollapsible(collapsePlaylistBtn, playlistCollapsible, 'musicPlaylistCollapsed', 'å±•å¼€åˆ—è¡¨', 'æ”¶èµ·åˆ—è¡¨');
    }
    init();
  </script>
</body>
</html>
