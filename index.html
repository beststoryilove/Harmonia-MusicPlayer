<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="description" content="Harmonia - ä¸€ä¸ªç¾è§‚æ˜“ç”¨çš„åœ¨çº¿éŸ³ä¹æ’­æ”¾å™¨ï¼Œæ”¯æŒæ­Œè¯æ˜¾ç¤ºã€æ’­æ”¾åˆ—è¡¨ç®¡ç†å’Œå¤šä¸»é¢˜åˆ‡æ¢" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Harmonia - éŸ³ä¹æ’­æ”¾å™¨</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    /* CSS Variables for better theming and consistency */
    :root {
      --bg-dark: linear-gradient(135deg, #1a1a2e, #16213e, #0f3460);
      --bg-light: linear-gradient(135deg, #e0e7ff, #dbeafe, #d1d5db);
      --text-dark: #fff;
      --text-light: #1e293b;
      --primary-color: #9b59b6; /* Purple */
      --primary-gradient: linear-gradient(135deg, #8e44ad, #9b59b6);
      --secondary-color: #6c5ce7; /* Indigo for share */
      --secondary-gradient: linear-gradient(135deg, #6c5ce7, #5d4bdb);
      --accent-color: #3498db; /* Blue for desktop lyrics */
      --accent-gradient: linear-gradient(135deg, #3498db, #2980b9);
      --card-bg-dark: rgba(30, 22, 45, 0.85);
      --card-bg-light: rgba(255, 255, 255, 0.85);
      --border-dark: rgba(255, 255, 255, 0.12);
      --border-light: rgba(0, 0, 0, 0.1);
      --shadow-dark: 0 12px 30px rgba(0, 0, 0, 0.6);
      --shadow-light: 0 12px 30px rgba(0, 0, 0, 0.15);
      --input-bg-dark: rgba(255, 255, 255, 0.08);
      --input-bg-light: rgba(0, 0, 0, 0.05);
      --item-bg-dark: rgba(0, 0, 0, 0.25);
      --item-bg-light: rgba(255, 255, 255, 0.7);
      --item-hover-dark: rgba(255, 255, 255, 0.12);
      --item-hover-light: rgba(0, 0, 0, 0.05);
      --active-item-bg-dark: linear-gradient(90deg, rgba(155, 89, 182, 0.15), rgba(155, 89, 182, 0.05));
      --active-item-bg-light: linear-gradient(90deg, rgba(155, 89, 182, 0.1), rgba(155, 89, 182, 0.03));
      --text-muted-dark: #aaa;
      --text-muted-light: #555;
      --error-color: #ff4d4d;
      --success-color: #2ecc71;
      --transition-speed: 0.3s;
      --border-radius-sm: 8px;
      --border-radius-md: 12px;
      --border-radius-lg: 16px;
      --border-radius-full: 50%;
    }

    *{margin:0;padding:0;box-sizing:border-box;} /* Reset all with box-sizing */

    body {
      font-family: 'Segoe UI', 'PingFang SC', 'Microsoft YaHei', sans-serif;
      min-height: 100vh;
      display: flex;
      padding: 20px;
      background: var(--bg-dark);
      color: var(--text-dark);
      position: relative;
      overflow-x: hidden;
      transition: background var(--transition-speed) ease, color var(--transition-speed) ease;
      background-size: cover; /* Ensure background image covers the entire body */
      background-position: center;
      background-attachment: fixed;
    }

    body.light-theme {
      background: var(--bg-light);
      color: var(--text-light);
    }

    /* Custom Scrollbar for better aesthetics */
    ::-webkit-scrollbar {
      width: 8px;
    }
    ::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
    }
    ::-webkit-scrollbar-thumb {
      background: var(--primary-color);
      border-radius: 10px;
      border: 2px solid rgba(0, 0, 0, 0.2);
    }
    body.light-theme ::-webkit-scrollbar-thumb {
      background: var(--primary-color);
      border: 2px solid rgba(255, 255, 255, 0.2);
    }

    /* General Button Styles */
    button {
      padding: 12px 18px;
      border: none;
      border-radius: 30px;
      cursor: pointer;
      font-size: 14px;
      z-index: 100;
      color: var(--text-dark);
      font-weight: 600;
      transition: all var(--transition-speed) ease;
      display: flex;
      align-items: center;
      gap: 8px;
      white-space: nowrap;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.3);
    }

    .save-wallpaper {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--primary-gradient);
      box-shadow: 0 4px 20px rgba(142, 68, 173, 0.3);
    }
    .save-wallpaper:hover {
      background: linear-gradient(135deg, #9b59b6, #8e44ad);
    }

    .desktop-lyrics-btn {
      position: fixed;
      bottom: 160px;
      right: 20px;
      background: var(--accent-gradient);
      box-shadow: 0 4px 20px rgba(52, 152, 219, 0.3);
    }
    .desktop-lyrics-btn::before { content: 'ğŸ¤'; font-size: 16px; }

    .desktop-lyrics-status {
      position: fixed;
      bottom: 120px;
      right: 20px;
      padding: 8px 15px;
      border-radius: 30px;
      font-size: 12px;
      z-index: 99;
      display: none;
      background: var(--card-bg-dark);
      border: 1px solid var(--border-dark);
      color: var(--text-muted-dark);
    }
    .desktop-lyrics-status.connected { color: var(--success-color); }
    .desktop-lyrics-status.disconnected { color: var(--error-color); }
    body.light-theme .desktop-lyrics-status {
      background: var(--card-bg-light);
      border: 1px solid var(--border-light);
      color: var(--text-muted-light);
    }

    .share-music {
      position: fixed;
      bottom: 90px;
      right: 20px;
      background: var(--secondary-gradient);
      box-shadow: 0 4px 20px rgba(108, 92, 231, 0.3);
    }
    .share-music::before { content: 'ğŸµ'; font-size: 16px; }

    .theme-toggle {
      position: fixed;
      top: 20px;
      right: 20px;
      width: 50px;
      height: 50px;
      border-radius: var(--border-radius-full);
      background: var(--card-bg-dark);
      backdrop-filter: blur(10px);
      border: 1px solid var(--border-dark);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 100;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
      transition: all var(--transition-speed) ease;
    }
    .theme-toggle:hover {
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
      transform: translateY(-2px);
    }
    .theme-toggle i {
      font-size: 24px;
      color: var(--primary-color);
    }
    body.light-theme .theme-toggle {
      background: var(--card-bg-light);
      border: 1px solid var(--border-light);
    }

    .top-info-bar {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      background: rgba(30, 22, 45, 0.9);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border-dark);
      z-index: 1000;
      padding: 8px 0;
      font-size: 12px;
    }
    .top-info-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 20px;
      color: var(--text-muted-dark);
    }
    .top-terms-link {
      color: var(--primary-color);
      text-decoration: none;
    }
    .top-terms-link:hover { text-decoration: underline; }
    body.light-theme .top-info-bar {
      background: rgba(255, 255, 255, 0.9);
      border-bottom: 1px solid var(--border-light);
    }
    body.light-theme .top-info-content {
      color: var(--text-muted-light);
    }

    .main-wrapper {
      display: flex;
      width: 100%;
      max-width: 1400px;
      margin: 60px auto 0;
      gap: 20px;
      min-height: 0; /* Allow flexible height */
    }

    .playlist-container, .container {
      background: var(--card-bg-dark);
      border-radius: var(--border-radius-lg);
      padding: 25px; /* Increased padding slightly for better look */
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow-dark);
      border: 1px solid var(--border-dark);
      display: flex;
      flex-direction: column;
      animation: slideInUp 0.6s ease-out; /* Changed from slideInLeft/Right for a unified entrance */
    }
    body.light-theme .playlist-container, body.light-theme .container {
      background: var(--card-bg-light);
      box-shadow: var(--shadow-light);
      border: 1px solid var(--border-light);
    }

    .playlist-container {
      width: 280px; /* Slightly wider */
      flex-shrink: 0; /* Prevent shrinking */
    }

    .playlist-tabs {
      display: flex;
      margin-bottom: 15px;
      border-bottom: 1px solid var(--border-dark);
    }
    body.light-theme .playlist-tabs {
      border-bottom: 1px solid var(--border-light);
    }
    .playlist-tab {
      padding: 10px 18px; /* Adjusted padding */
      cursor: pointer;
      font-size: 15px; /* Slightly larger font */
      font-weight: 500;
      color: var(--text-muted-dark);
      transition: all var(--transition-speed) ease;
      border-bottom: 2px solid transparent;
    }
    .playlist-tab:hover {
      color: var(--primary-color);
    }
    .playlist-tab.active {
      color: var(--primary-color);
      border-bottom: 2px solid var(--primary-color);
      font-weight: 600;
    }
    body.light-theme .playlist-tab {
      color: var(--text-muted-light);
    }

    .playlist-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--border-dark);
    }
    body.light-theme .playlist-header {
      border-bottom: 1px solid var(--border-light);
    }
    .playlist-title {
      font-size: 19px; /* Slightly larger */
      font-weight: 700;
      color: var(--primary-color);
      letter-spacing: 0.5px;
    }
    .clear-playlist {
      background: none;
      border: none;
      color: var(--text-muted-dark);
      cursor: pointer;
      font-size: 13px; /* Slightly larger */
      padding: 6px 10px; /* Adjusted padding */
      border-radius: var(--border-radius-sm);
      transition: all var(--transition-speed) ease;
      box-shadow: none; /* Override default button shadow */
    }
    .clear-playlist:hover {
      color: var(--error-color);
      background: rgba(255, 77, 77, 0.1);
      transform: none; /* Override default button transform */
      box-shadow: none;
    }
    body.light-theme .clear-playlist {
      color: var(--text-muted-light);
    }

    .header-actions { display: flex; align-items: center; gap: 8px; }
    .collapse-toggle {
      background: none;
      border: none;
      color: var(--text-muted-dark);
      cursor: pointer;
      width: 36px; /* Larger target area */
      height: 36px;
      border-radius: var(--border-radius-full);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all var(--transition-speed) ease;
      box-shadow: none;
    }
    .collapse-toggle:hover {
      background: var(--item-hover-dark);
      color: var(--primary-color);
      transform: none;
      box-shadow: none;
    }
    body.light-theme .collapse-toggle {
      color: var(--text-muted-light);
    }
    body.light-theme .collapse-toggle:hover {
      background: var(--item-hover-light);
    }
    .collapse-toggle i { transition: transform 0.25s ease; }
    .playlist-collapsible.hidden { display: none; }

    .playlist-items {
      flex: 1;
      overflow-y: auto;
      padding-right: 5px; /* Space for scrollbar */
    }
    .playlist-item {
      padding: 12px 15px;
      margin-bottom: 8px;
      border-radius: 10px;
      background: var(--item-bg-dark);
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all var(--transition-speed) ease;
      border-left: 3px solid transparent;
      animation: fadeIn 0.5s ease;
    }
    .playlist-item:hover {
      background: var(--item-hover-dark);
      transform: translateY(-2px);
    }
    .playlist-item.active {
      background: var(--active-item-bg-dark);
      border-left: 3px solid var(--primary-color);
      animation: pulse 2s infinite;
    }
    body.light-theme .playlist-item {
      background: var(--item-bg-light);
    }
    body.light-theme .playlist-item:hover {
      background: var(--item-hover-light);
    }
    body.light-theme .playlist-item.active {
      background: var(--active-item-bg-light);
    }

    .playlist-item-info { flex: 1; overflow: hidden; }
    .playlist-item-title {
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-size: 15px; /* Slightly larger */
      margin-bottom: 3px;
    }
    .playlist-item-artist {
      font-size: 13px;
      color: var(--text-muted-dark);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    body.light-theme .playlist-item-artist {
      color: var(--text-muted-light);
    }

    .remove-from-playlist {
      background: none;
      border: none;
      color: var(--text-muted-dark);
      cursor: pointer;
      margin-left: 10px;
      font-size: 18px; /* Larger icon */
      transition: color 0.2s, background 0.2s;
      width: 28px; /* Larger target area */
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: var(--border-radius-full);
    }
    .remove-from-playlist:hover {
      color: var(--error-color);
      background: rgba(255, 77, 77, 0.1);
    }
    body.light-theme .remove-from-playlist {
      color: var(--text-muted-light);
    }

    .container {
      flex: 1;
    }
    h1 {
      text-align: center;
      margin-bottom: 25px;
      color: var(--primary-color);
      font-size: 32px;
      font-weight: 800;
      text-shadow: 0 2px 10px rgba(155, 89, 182, 0.3);
      letter-spacing: 1px;
      position: relative;
      padding-bottom: 15px;
    }
    h1::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 100px;
      height: 3px;
      background: linear-gradient(90deg, transparent, var(--primary-color), transparent);
      border-radius: 3px;
    }

    .search-container { display: flex; margin-bottom: 20px; position: relative; }
    .search-input {
      flex: 1;
      padding: 14px 20px;
      border: 1px solid transparent; /* Add a subtle border */
      border-radius: 30px 0 0 30px;
      font-size: 16px;
      background: var(--input-bg-dark);
      color: var(--text-dark);
      outline: none;
      transition: all var(--transition-speed) ease;
      font-weight: 500;
    }
    .search-input:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(155, 89, 182, 0.3);
    }
    body.light-theme .search-input {
      background: var(--input-bg-light);
      color: var(--text-light);
    }
    .search-button {
      padding: 14px 25px;
      background: var(--primary-gradient);
      color: var(--text-dark);
      border: none;
      border-radius: 0 30px 30px 0;
      cursor: pointer;
      font-size: 16px;
      transition: all var(--transition-speed) ease;
      font-weight: 600;
      box-shadow: none; /* Override general button shadow */
    }
    .search-button:hover {
      background: linear-gradient(135deg, #9b59b6, #8e44ad);
      transform: none; /* Override general button transform */
      box-shadow: 0 4px 10px rgba(155, 89, 182, 0.3);
    }

    .search-results {
      max-height: 250px; /* Slightly taller */
      overflow-y: auto;
      margin-bottom: 20px;
      border-radius: var(--border-radius-md);
      background: var(--item-bg-dark);
      border: 1px solid var(--border-dark);
    }
    body.light-theme .search-results {
      background: var(--item-bg-light);
      border: 1px solid var(--border-light);
    }
    .result-item {
      padding: 16px;
      border-bottom: 1px solid var(--border-dark);
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      justify-content: space-between;
      align-items: center;
      animation: fadeIn 0.4s ease;
    }
    .search-results .result-item:last-child {
      border-bottom: none; /* No border for the last item */
    }
    .result-item:hover { background: var(--item-hover-dark); }
    .result-item.active { background: var(--active-item-bg-dark); }
    body.light-theme .result-item { border-bottom: 1px solid var(--border-light); }
    body.light-theme .result-item:hover { background: var(--item-hover-light); }
    body.light-theme .result-item.active { background: var(--active-item-bg-light); }

    .song-info { flex: 1; margin-right: 10px; }
    .song-title {
      font-weight: 600;
      margin-bottom: 6px;
      color: var(--text-dark);
      font-size: 16px; /* Slightly larger */
    }
    .song-artist, .song-album {
      font-size: 13px;
      color: var(--text-muted-dark);
    }
    body.light-theme .song-title { color: var(--text-light); }
    body.light-theme .song-artist, body.light-theme .song-album { color: var(--text-muted-light); }

    .add-to-playlist, .add-to-favorites {
      background: none;
      border: none;
      color: var(--primary-color);
      cursor: pointer;
      font-size: 20px; /* Adjusted icon size */
      margin-left: 10px;
      width: 38px; /* Larger target area */
      height: 38px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: var(--border-radius-full);
      transition: all 0.2s;
      box-shadow: none;
    }
    .add-to-playlist:hover, .add-to-favorites:hover {
      background: rgba(155, 89, 182, 0.15);
      transform: scale(1.1);
    }
    .add-to-favorites.active {
      color: var(--success-color); /* Feedback for added to favorites */
    }

    .pagination { display: flex; justify-content: center; margin-top: 15px; gap: 12px; }
    .page-button {
      padding: 8px 16px;
      background: var(--item-bg-dark);
      border: none;
      border-radius: var(--border-radius-sm);
      color: var(--text-dark);
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s;
    }
    .page-button:hover:not(:disabled) {
      background: var(--item-hover-dark);
    }
    .page-button.active { background: var(--primary-gradient); color: var(--text-dark); }
    .page-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    body.light-theme .page-button {
      background: var(--item-bg-light);
      color: var(--text-light);
    }
    body.light-theme .page-button:hover:not(:disabled) {
      background: var(--item-hover-light);
    }
    body.light-theme .page-button.active {
      color: var(--text-dark); /* text-dark for gradient background */
    }

    .player-container {
      display: flex;
      flex: 1;
      margin-top: 20px;
      gap: 25px;
      min-height: 400px;
    }
    .player-left {
      width: 280px;
      flex-shrink: 0;
      display: flex;
      flex-direction: column;
      align-items: center; /* Center player-left contents */
    }
    .album-art-container {
      position: relative;
      width: 100%;
      border-radius: var(--border-radius-md);
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      margin-bottom: 25px;
      perspective: 1000px;
      transform-style: preserve-3d;
      transition: transform 0.5s ease;
      background: rgba(0,0,0,0.3); /* Placeholder background */
    }
    .album-art-wrapper { width: 100%; height: 0; padding-bottom: 100%; position: relative; }
    .album-art {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.5s ease, opacity 0.5s ease;
      border-radius: var(--border-radius-md);
      opacity: 0; /* Initial opacity for fade-in */
    }
    .album-art.loaded {
      opacity: 1;
    }
    .album-art-container:hover .album-art { transform: scale(1.05); }
    .album-art-overlay {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(transparent, rgba(0, 0, 0, 0.8)); /* Darker gradient */
      padding: 15px;
      text-align: center;
      color: var(--text-dark);
    }
    .player-info {
      text-align: center;
      margin-bottom: 25px;
      width: 100%;
    }
    .now-playing-title {
      font-size: 24px; /* Larger title */
      font-weight: 700;
      margin-bottom: 8px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      color: var(--primary-color); /* Highlight title */
    }
    .now-playing-artist {
      font-size: 16px;
      color: var(--text-muted-dark);
      margin-bottom: 5px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .now-playing-album {
      font-size: 14px;
      color: var(--text-muted-dark);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    body.light-theme .now-playing-artist, body.light-theme .now-playing-album {
      color: var(--text-muted-light);
    }

    .progress-container { width: 100%; margin-bottom: 20px; }
    .progress-bar {
      width: 100%;
      height: 8px; /* Thicker progress bar */
      background: rgba(255, 255, 255, 0.15);
      border-radius: 4px; /* Smoother corners */
      cursor: pointer;
      margin-bottom: 8px;
      overflow: hidden;
      position: relative;
    }
    .progress {
      height: 100%;
      background: var(--primary-gradient);
      border-radius: 4px;
      width: 0%;
      position: relative;
      transition: width 0.1s linear;
      will-change: width; /* Performance hint */
    }
    .progress::after {
      content: '';
      position: absolute;
      top: 50%;
      right: 0;
      width: 14px; /* Larger handle */
      height: 14px;
      background: #fff;
      border-radius: var(--border-radius-full);
      transform: translate(50%, -50%);
      box-shadow: 0 0 10px rgba(155, 89, 182, 0.8);
      opacity: 0;
      transition: opacity 0.2s;
    }
    .progress-bar:hover .progress::after { opacity: 1; }
    .time-info {
      display: flex;
      justify-content: space-between;
      font-size: 14px; /* Slightly larger */
      color: var(--text-muted-dark);
    }
    body.light-theme .progress-bar {
      background: rgba(0, 0, 0, 0.1);
    }
    body.light-theme .time-info {
      color: var(--text-muted-light);
    }

    .controls {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 20px;
      margin-bottom: 20px;
      position: relative;
      flex-wrap: wrap; /* Allow wrapping on smaller screens */
    }
    .control-button {
      background: var(--item-bg-dark);
      border: none;
      color: var(--text-dark);
      font-size: 22px;
      cursor: pointer;
      width: 48px; /* Slightly larger */
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: var(--border-radius-full);
      transition: all var(--transition-speed) ease;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    }
    .control-button:hover {
      background: var(--item-hover-dark);
      transform: translateY(-2px) scale(1.05); /* Added scale */
      color: var(--primary-color);
    }
    body.light-theme .control-button {
      background: var(--item-bg-light);
      color: var(--text-light);
    }
    body.light-theme .control-button:hover {
      background: var(--item-hover-light);
    }

    .play-button {
      background: var(--primary-gradient);
      width: 65px; /* Larger play button */
      height: 65px;
      font-size: 30px; /* Larger icon */
      border-radius: var(--border-radius-full);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 6px 20px rgba(155, 89, 182, 0.4);
      transition: all var(--transition-speed) ease;
      color: #fff; /* Ensure white icon */
    }
    .play-button:hover {
      background: linear-gradient(135deg, #9b59b6, #8e44ad);
      transform: scale(1.08); /* More pronounced hover effect */
    }

    .volume-container {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-left: 15px; /* Adjusted margin */
      background: var(--item-bg-dark);
      padding: 8px 15px;
      border-radius: 30px;
    }
    body.light-theme .volume-container {
      background: var(--item-bg-light);
    }
    .volume-icon {
      font-size: 18px;
      color: var(--text-muted-dark);
    }
    body.light-theme .volume-icon {
      color: var(--text-muted-light);
    }
    .volume-slider {
      width: 90px;
      -webkit-appearance: none;
      height: 5px;
      background: rgba(255, 255, 255, 0.15);
      border-radius: 5px;
      outline: none;
      cursor: grab;
    }
    body.light-theme .volume-slider {
      background: rgba(0, 0, 0, 0.1);
    }
    .volume-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 16px; /* Larger thumb */
      height: 16px;
      border-radius: var(--border-radius-full);
      background: var(--primary-color);
      cursor: grab;
      box-shadow: 0 0 8px rgba(155, 89, 182, 0.8);
      transition: all 0.2s;
    }
    .volume-slider::-webkit-slider-thumb:active {
      cursor: grabbing;
    }

    .play-mode-btn {
      background: none;
      border: none;
      color: var(--text-muted-dark);
      font-size: 20px; /* Larger icon */
      cursor: pointer;
      margin-left: 10px;
      width: 40px; /* Larger target area */
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: var(--border-radius-full);
      transition: all var(--transition-speed) ease;
    }
    .play-mode-btn:hover {
      background: var(--item-hover-dark);
      color: var(--primary-color);
    }
    body.light-theme .play-mode-btn {
      color: var(--text-muted-light);
    }
    body.light-theme .play-mode-btn:hover {
      background: var(--item-hover-light);
    }

    .lyrics-container {
      flex: 1;
      overflow-y: auto;
      scroll-behavior: smooth;
      padding: 20px;
      background: var(--item-bg-dark); /* Consistent background with other items */
      border-radius: var(--border-radius-md);
      margin-left: 20px;
      position: relative;
      min-height: 300px;
      max-height: 60vh; /* Adjust max height for better aspect ratio */
      transition: all var(--transition-speed) ease;
    }
    body.light-theme .lyrics-container {
      background: var(--item-bg-light);
    }
    .lyrics-content {
      text-align: center;
      transition: transform 0.1s ease-out; /* Keep transform for potential smooth scrolling optimization */
      padding: 20px 0;
    }
    .lyric-line {
      margin: 18px 0; /* Increased margin */
      color: rgba(255, 255, 255, 0.7);
      font-size: 18px;
      line-height: 1.7;
      transition: all 0.3s;
      min-height: 28px;
      font-weight: 300;
      opacity: 0.8;
      cursor: pointer;
      padding: 0 10px; /* Add horizontal padding */
    }
    .lyric-line.active {
      color: #fff;
      font-size: 22px;
      font-weight: 600;
      opacity: 1;
      text-shadow: 0 0 10px rgba(255, 255, 255, 0.3), 0 0 20px rgba(155, 89, 182, 0.5); /* Enhanced shadow */
      transition: all 0.1s ease;
    }
    .lyric-line.translation {
      color: rgba(170, 170, 170, 0.8);
      font-size: 16px;
      margin-top: -10px;
      margin-bottom: 20px;
      min-height: 22px;
      font-style: italic;
    }
    .no-lyrics {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: var(--text-muted-dark);
      font-size: 18px;
      font-style: italic;
      white-space: nowrap;
    }
    body.light-theme .lyric-line {
      color: rgba(0, 0, 0, 0.7);
    }
    body.light-theme .lyric-line.active {
      color: var(--text-light);
      text-shadow: 0 0 10px rgba(0, 0, 0, 0.1), 0 0 20px rgba(155, 89, 182, 0.2);
    }
    body.light-theme .lyric-line.translation {
      color: rgba(85, 85, 85, 0.8);
    }
    body.light-theme .no-lyrics {
      color: var(--text-muted-light);
    }

    .loading {
      display: none;
      text-align: center;
      padding: 25px;
      color: var(--text-muted-dark);
      font-size: 18px;
    }
    .loading.active { display: block; }
    .loading::after {
      content: '.';
      animation: loadingDots 1.5s infinite steps(4); /* Steps for dot animation */
    }
    @keyframes loadingDots {
      0%, 20% { content: '.'; }
      40% { content: '..'; }
      60% { content: '...'; }
      80%, 100% { content: ''; } /* Hide at 100% to create a blink effect */
    }
    body.light-theme .loading {
      color: var(--text-muted-light);
    }

    .error {
      color: var(--error-color);
      text-align: center;
      padding: 12px;
      display: none;
      background: rgba(255, 77, 77, 0.1);
      border-radius: var(--border-radius-sm);
      margin-bottom: 15px;
      font-weight: 500;
      animation: shake 0.5s ease-in-out;
      border: 1px solid var(--error-color); /* Add border for emphasis */
    }
    .error.active { display: block; }
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
      20%, 40%, 60%, 80% { transform: translateX(5px); }
    }

    /* General Animations */
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(155, 89, 182, 0.4); }
      70% { box-shadow: 0 0 0 10px rgba(155, 89, 182, 0); }
      100% { box-shadow: 0 0 0 0 rgba(155, 89, 182, 0); }
    }

    /* Modal Styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      display: flex; /* Changed from none to flex by JS when showing */
      justify-content: center;
      align-items: center;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    .modal-overlay.show { opacity: 1; }
    .modal-content {
      background-color: #282828;
      border-radius: var(--border-radius-lg);
      padding: 25px;
      width: 90%;
      max-width: 500px;
      max-height: 80vh;
      overflow: hidden; /* changed to hidden as scroll is on list */
      box-shadow: var(--shadow-dark);
      transform: translateY(-20px);
      transition: transform 0.3s ease, opacity 0.3s ease;
      opacity: 0;
      position: relative;
      display: flex; /* Added for better internal layout control */
      flex-direction: column; /* Arrange children vertically */
    }
    .modal-overlay.show .modal-content {
      transform: translateY(0);
      opacity: 1;
    }
    body.light-theme .modal-content {
      background-color: #f0f4f8;
      box-shadow: var(--shadow-light);
    }
    .modal-content h2 {
      color: var(--primary-color);
      margin-bottom: 20px;
      text-align: center;
      font-size: 24px;
    }
    .modal-content p {
      color: var(--text-muted-dark);
      margin-bottom: 20px;
      font-size: 14px;
    }
    body.light-theme .modal-content p {
      color: var(--text-muted-light);
    }
    .modal-song-list {
      margin-bottom: 20px;
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid var(--border-dark);
      border-radius: var(--border-radius-md);
      padding-right: 5px; /* Space for scrollbar */
      flex-grow: 1; /* Allow song list to take available space */
    }
    body.light-theme .modal-song-list {
      border: 1px solid var(--border-light);
    }
    .modal-song-row {
      display: flex;
      align-items: center;
      padding: 10px;
      margin-bottom: 5px;
      background: var(--item-bg-dark);
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .modal-song-row:hover { background: var(--item-hover-dark); }
    body.light-theme .modal-song-row { background: var(--item-bg-light); }
    body.light-theme .modal-song-row:hover { background: var(--item-hover-light); }

    .modal-song-row input[type="checkbox"] {
      margin-right: 10px;
      accent-color: var(--primary-color); /* Style checkbox */
    }
    .modal-song-info { flex: 1; }
    .modal-song-title {
      font-weight: bold;
      margin-bottom: 3px;
      color: var(--text-dark);
    }
    .modal-song-artist {
      font-size: 12px;
      color: var(--text-muted-dark);
    }
    body.light-theme .modal-song-title { color: var(--text-light); }
    body.light-theme .modal-song-artist { color: var(--text-muted-light); }

    .modal-buttons {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 15px; /* Added margin below action buttons */
    }
    .modal-buttons button {
      flex: 1;
      padding: 10px 15px;
      border-radius: 25px;
      box-shadow: none;
      transform: none;
      font-size: 14px;
    }
    .modal-buttons .btn-export { background: var(--primary-gradient); }
    .modal-buttons .btn-import { background: var(--secondary-gradient); }

    /* Specific style for the Cancel button */
    .modal-content > .btn-cancel {
      background: var(--error-color);
      color: var(--text-dark);
      padding: 10px 15px;
      border-radius: 25px;
      box-shadow: 0 4px 10px rgba(255, 77, 77, 0.3);
      margin: 10px auto 0 auto; /* Center it horizontally with top margin */
      display: block; /* Ensure it respects margin: auto */
      width: fit-content; /* Make its width fit content */
      min-width: 120px; /* Minimum width for better appearance */
      text-align: center; /* Center text inside the button */
      transition: all var(--transition-speed) ease;
    }
    .modal-content > .btn-cancel:hover {
      background: #e74c3c;
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(255, 77, 77, 0.4);
    }

    /* Mobile styles */
    @media (max-width: 768px) {
      body { padding: 10px; }
      .main-wrapper { flex-direction: column; gap: 15px; margin-top: 50px; }
      .playlist-container, .container { width: 100%; max-width: 100%; padding: 15px; }
      .player-container { flex-direction: column; min-height: auto; gap: 15px; margin-top: 15px; }
      .player-left { width: 100%; align-items: center; }
      .album-art-container { margin-bottom: 15px; }
      .lyrics-container { margin-left: 0; margin-top: 15px; min-height: 200px; max-height: 40vh; padding: 15px; }
      .control-button, .play-button { width: 50px; height: 50px; font-size: 20px; }
      .play-button { width: 65px; height: 65px; font-size: 28px; }
      .search-container { flex-direction: column; }
      .search-input { border-radius: 30px; margin-bottom: 10px; padding: 12px 15px; }
      .search-button { border-radius: 30px; width: 100%; padding: 12px 15px; }
      .share-music { bottom: 70px; padding: 10px 15px; font-size: 13px; }
      .desktop-lyrics-btn, .desktop-lyrics-status { display: none !important; } /* Hide on mobile */
      .top-info-content { flex-direction: column; gap: 4px; padding: 0 10px; text-align: center; }
      .save-wallpaper { bottom: 20px; padding: 10px 15px; font-size: 13px; }
      h1 { font-size: 28px; margin-bottom: 20px; padding-bottom: 10px; }
      .lyrics-content { padding: 10px 0; }
      .lyric-line.active { font-size: 20px; }
      .lyric-line.translation { font-size: 14px; }
      .playlist-tab { font-size: 14px; padding: 8px 12px; }
      .playlist-item-title { font-size: 14px; }
      .playlist-item-artist { font-size: 12px; }
      .now-playing-title { font-size: 20px; }
      .now-playing-artist { font-size: 14px; }
      .now-playing-album { font-size: 12px; }
      .volume-container { margin-left: 0; margin-top: 10px; width: 100%; justify-content: center; }
      .volume-slider { width: 150px; } /* Adjust volume slider width */
      .controls { gap: 15px; }
    }
  </style>
</head>
<body>
  <div class="top-info-bar">
    <div class="top-info-content">
      <span>Â©HarmoniaéŸ³ä¹æ’­æ”¾å™¨(2024-2025) ç‰ˆæƒå½’Harmoniaå›¢é˜Ÿæ‰€æœ‰ ä¸¥ç¦å€’å–/å•†ä¸šè¡Œä¸º</span>
      <a href="tiaokuan.html" class="top-terms-link">ç‚¹å‡»è·³è½¬éšç§æ”¿ç­–ä»¥åŠç”¨æˆ·æ¡æ¬¾</a>
    </div>
  </div>

  <!-- æ‚¬æµ®æŒ‰é’® -->
  <button class="desktop-lyrics-btn" id="desktopLyricsBtn">å¼€å¯æ¡Œé¢æ­Œè¯ï¼ˆæ¡Œé¢ç«¯é™å®šï¼‰</button>
  <div class="desktop-lyrics-status" id="desktopLyricsStatus">æœªè¿æ¥æ¡Œé¢æ­Œè¯ç¨‹åº</div>
  <button class="share-music" id="shareMusicBtn"><span class="button-text">å‘ç°äº†å®è—æ­Œæ›²æƒ³åˆ†äº«ï¼Ÿç‚¹æˆ‘ï¼</span><span class="mobile-text" style="display:none">åˆ†äº«æ­Œæ›²</span></button>
  <button class="save-wallpaper" id="saveWallpaperBtn">å£çº¸å¥½çœ‹å—ï¼Ÿç‚¹æˆ‘ç«‹å³ä¿å­˜ï¼</button>
  <div class="theme-toggle" id="themeToggle"><i class="fas fa-moon"></i></div>

  <div class="main-wrapper">
    <!-- å·¦ä¾§ï¼šåˆ—è¡¨ï¼ˆæ”¯æŒæŠ˜å ï¼‰ -->
    <div class="playlist-container">
      <div class="playlist-tabs">
        <div class="playlist-tab active" data-tab="playlist">æ’­æ”¾åˆ—è¡¨</div>
        <div class="playlist-tab" data-tab="favorites">æˆ‘çš„æ”¶è—</div>
        <div class="playlist-tab" data-tab="history">æ’­æ”¾å†å²</div>
      </div>
      <div class="playlist-header">
        <div class="playlist-title" id="playlistTitle">æ’­æ”¾åˆ—è¡¨</div>
        <div class="header-actions">
          <button class="clear-playlist" id="clearPlaylist" title="æ¸…ç©ºå½“å‰åˆ—è¡¨">æ¸…ç©º</button>
          <!-- æŠ˜å æŒ‰é’® -->
          <button class="collapse-toggle" id="collapsePlaylist" aria-expanded="true" title="æ”¶èµ·åˆ—è¡¨">
            <i class="fas fa-chevron-up"></i>
          </button>
        </div>
      </div>
      <!-- æŠ˜å åŒ…è£¹å±‚ -->
      <div class="playlist-collapsible" id="playlistCollapsible">
        <div class="playlist-items" id="playlistItems"></div>
      </div>
    </div>

    <!-- å³ä¾§ï¼šä¸»å®¹å™¨ -->
    <div class="container">
      <h1>Harmonia - éŸ³ä¹æ’­æ”¾å™¨</h1>

      <div class="search-container">
        <input type="text" class="search-input" id="searchInput" placeholder="æœç´¢æ­Œæ›²ã€æ­Œæ‰‹æˆ–ä¸“è¾‘..." autocomplete="off" aria-label="æœç´¢æ¡†" />
        <button class="search-button" id="searchButton" aria-label="æœç´¢">æœç´¢</button>
      </div>

      <div class="error" id="errorMessage" role="alert"></div>
      <div class="loading" id="loadingIndicator" aria-live="polite">åŠ è½½ä¸­</div>

      <!-- æœç´¢ç»“æœï¼šä¿æŒç®€å•ï¼Œæ— æŠ˜å  -->
      <div class="search-results" id="searchResults"></div>

      <div class="pagination" id="pagination" role="navigation" aria-label="æœç´¢ç»“æœåˆ†é¡µ"></div>

      <div class="player-container" id="playerContainer" style="display:none;">
        <div class="player-left">
          <div class="album-art-container" id="albumArtContainer">
            <div class="album-art-wrapper">
              <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="ä¸“è¾‘å°é¢" class="album-art" id="albumArt" loading="lazy" />
            </div>
            <div class="album-art-overlay">
              <div class="now-playing-title" id="nowPlayingTitle">æ­Œæ›²æ ‡é¢˜</div>
              <div class="now-playing-artist" id="nowPlayingArtist">æ­Œæ‰‹</div>
            </div>
          </div>

          <div class="player-info">
            <div class="now-playing-album" id="nowPlayingAlbum">ä¸“è¾‘</div>
          </div>

          <div class="progress-container">
            <div class="progress-bar" id="progressBar" role="slider" aria-label="æ’­æ”¾è¿›åº¦æ¡" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
              <div class="progress" id="progress"></div>
            </div>
            <div class="time-info">
              <span id="currentTime">0:00</span>
              <span id="duration">0:00</span>
            </div>
          </div>

          <div class="controls">
            <button class="control-button" id="prevButton" aria-label="ä¸Šä¸€æ›²">â®</button>
            <button class="control-button play-button" id="playButton" aria-label="æ’­æ”¾/æš‚åœ">â–¶</button>
            <button class="control-button" id="nextButton" aria-label="ä¸‹ä¸€æ›²">â­</button>
            <button class="play-mode-btn" id="playModeBtn" title="å¾ªç¯æ’­æ”¾" aria-label="æ’­æ”¾æ¨¡å¼"><i class="fas fa-redo"></i></button>
            <div class="volume-container">
              <span class="volume-icon" aria-hidden="true">ğŸ”Š</span>
              <input type="range" class="volume-slider" id="volumeSlider" min="0" max="1" step="0.01" value="0.7" aria-label="éŸ³é‡è°ƒèŠ‚" />
            </div>
          </div>
        </div>

        <div class="lyrics-container" id="lyricsScrollContainer">
          <div class="lyrics-content" id="lyricsContent">
            <div class="no-lyrics">æš‚æ— æ­Œè¯</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <audio id="audioPlayer"></audio>

  <script>
    // ===== DOM Cache =====
    const searchInput = document.getElementById('searchInput');
    const searchButton = document.getElementById('searchButton');
    const searchResults = document.getElementById('searchResults');
    const playerContainer = document.getElementById('playerContainer');
    const albumArt = document.getElementById('albumArt');
    const albumArtContainer = document.getElementById('albumArtContainer');
    const nowPlayingTitle = document.getElementById('nowPlayingTitle');
    const nowPlayingArtist = document.getElementById('nowPlayingArtist');
    const nowPlayingAlbum = document.getElementById('nowPlayingAlbum');
    const progressBar = document.getElementById('progressBar');
    const progress = document.getElementById('progress');
    const currentTimeDisplay = document.getElementById('currentTime');
    const durationDisplay = document.getElementById('duration');
    const playButton = document.getElementById('playButton');
    const prevButton = document.getElementById('prevButton');
    const nextButton = document.getElementById('nextButton');
    const audioPlayer = document.getElementById('audioPlayer');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const errorMessage = document.getElementById('errorMessage');
    const pagination = document.getElementById('pagination');
    const volumeSlider = document.getElementById('volumeSlider');
    const playlistItems = document.getElementById('playlistItems');
    const clearPlaylist = document.getElementById('clearPlaylist');
    const saveWallpaperBtn = document.getElementById('saveWallpaperBtn');
    const lyricsContent = document.getElementById('lyricsContent');
    const lyricsScrollContainer = document.getElementById('lyricsScrollContainer'); // Added for scrolling lyrics
    const shareMusicBtn = document.getElementById('shareMusicBtn');
    const desktopLyricsBtn = document.getElementById('desktopLyricsBtn');
    const desktopLyricsStatus = document.getElementById('desktopLyricsStatus');
    const themeToggle = document.getElementById('themeToggle');
    const playlistTabs = document.querySelectorAll('.playlist-tab');
    const playlistTitle = document.getElementById('playlistTitle');
    const playModeBtn = document.getElementById('playModeBtn');
    const collapsePlaylistBtn = document.getElementById('collapsePlaylist');
    const playlistCollapsible = document.getElementById('playlistCollapsible');
    const originalTitle = "Harmonia - éŸ³ä¹æ’­æ”¾å™¨";

    // ===== State =====
    let currentPage = 1;
    let currentSearchResults = [];
    let currentTrackIndex = -1; // Index in search results
    let playlist = JSON.parse(localStorage.getItem('musicPlaylist')) || [];
    let favorites = JSON.parse(localStorage.getItem('musicFavorites')) || [];
    let history = JSON.parse(localStorage.getItem('musicHistory')) || [];
    let currentPlaylistIdx = -1; // Index in the active playlist (can be playlist, favorites, history)
    let currentActivePlaylist = playlist; // Reference to the currently displayed playlist array
    let currentWallpaperUrl = '';
    let lyricsData = [];
    let isPlaying = false;
    let isLyricTitleActive = false; // To prevent excessive title updates
    let ws = null;
    let desktopLyricsEnabled = false;
    let currentLyricsResponse = null; // Store full lyrics response for desktop client
    let currentPlayMode = 'normal'; // normal, repeat, shuffle
    let currentTab = 'playlist'; // 'playlist', 'favorites', 'history'

    // Debounce/Throttle variables
    // let searchTimeout = null; // No longer needed for input event
    // let volumeTimeout = null; // Not needed if debounce handles it

    audioPlayer.volume = parseFloat(localStorage.getItem('musicPlayerVolume') || '0.7'); // Persist volume
    volumeSlider.value = audioPlayer.volume;

    // ===== Utility Functions =====
    function clearError() { errorMessage.classList.remove('active'); errorMessage.textContent = ''; }
    function showError(msg, duration = 3000) { errorMessage.textContent = msg; errorMessage.classList.add('active'); if (duration) { setTimeout(() => clearError(), duration); } }
    function isMobile() { return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent); }

    function optimizeMobileButtons() {
      if (isMobile()) {
        desktopLyricsBtn.style.display = 'none';
        desktopLyricsStatus.style.display = 'none';
        // Use spans for mobile text to switch content easily
        shareMusicBtn.querySelector('.button-text').style.display = 'none';
        shareMusicBtn.querySelector('.mobile-text').style.display = 'inline';
        saveWallpaperBtn.textContent = 'ä¿å­˜å£çº¸';
      }
    }

    function initTheme() {
      const saved = localStorage.getItem('musicPlayerTheme') || 'dark';
      if (saved === 'light') { document.body.classList.add('light-theme'); themeToggle.innerHTML = '<i class="fas fa-sun"></i>'; }
      else { document.body.classList.remove('light-theme'); themeToggle.innerHTML = '<i class="fas fa-moon"></i>'; }
    }
    function toggleTheme() {
      if (document.body.classList.contains('light-theme')) { document.body.classList.remove('light-theme'); localStorage.setItem('musicPlayerTheme', 'dark'); themeToggle.innerHTML = '<i class="fas fa-moon"></i>'; }
      else { document.body.classList.add('light-theme'); localStorage.setItem('musicPlayerTheme', 'light'); themeToggle.innerHTML = '<i class="fas fa-sun"></i>'; }
    }

    function updatePageTitle() {
      if (isPlaying && nowPlayingTitle.textContent && nowPlayingArtist.textContent && nowPlayingTitle.textContent !== 'æ­Œæ›²æ ‡é¢˜') {
        document.title = `æ­£åœ¨ä¸ºæ‚¨æ’­æ”¾ï¼šã€Š${nowPlayingTitle.textContent}ã€‹â€”â€”${nowPlayingArtist.textContent}`;
      } else {
        document.title = originalTitle;
      }
      isLyricTitleActive = false; // Reset lyric title state
    }

    function formatTime(sec) {
      const m = Math.floor(sec / 60);
      const s = Math.floor(sec % 60);
      return `${m}:${s < 10 ? '0' : ''}${s}`;
    }

    // Debounce function
    function debounce(func, delay) {
      let timeout;
      return function(...args) {
        const context = this;
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(context, args), delay);
      };
    }

    // ===== Lyrics Handling =====
    function parseLyrics(lyricText) {
      if (!lyricText) return [];
      const lines = lyricText.split('\n');
      const res = [];
      const re = /\[(\d{2}):(\d{2})\.(\d{2,3})\]/g; // Use global flag to match all timestamps in a line

      for (const line of lines) {
        let match;
        const lineTimestamps = [];
        let cleanLine = line;

        // Extract all timestamps from the line
        while ((match = re.exec(line)) !== null) {
          const min = parseInt(match[1]);
          const sec = parseInt(match[2]);
          const ms = parseInt(match[3]);
          const time = min * 60 + sec + ms / (match[3].length === 2 ? 100 : 1000);
          lineTimestamps.push(time);
          cleanLine = cleanLine.replace(match[0], ''); // Remove timestamp from the line
        }

        cleanLine = cleanLine.trim();
        if (cleanLine && lineTimestamps.length > 0) {
          // If multiple timestamps on one line, use the earliest one
          res.push({ time: Math.min(...lineTimestamps), text: cleanLine });
        } else if (cleanLine) {
            // Handle lines without timestamps as regular text, assigning time -1
            res.push({ time: -1, text: cleanLine });
        }
      }
      // Sort lyrics by time, pushing non-timed lyrics to the end or filtering them out based on requirement
      // For lyric display, we only care about timed lyrics, non-timed can be displayed at the start if needed
      return res.filter(l => l.time !== -1).sort((a, b) => a.time - b.time);
    }


    function displayLyrics(lyricResponse) {
      lyricsContent.innerHTML = '';
      if (!lyricResponse || (!lyricResponse.lyric && !lyricResponse.tlyric)) {
        lyricsContent.innerHTML = '<div class="no-lyrics">æš‚æ— æ­Œè¯</div>';
        lyricsData = [];
        return;
      }

      const mainLyrics = lyricResponse.lyric ? parseLyrics(lyricResponse.lyric) : [];
      const hasTranslation = lyricResponse.tlyric && lyricResponse.tlyric.trim() !== '';
      const translatedLyrics = hasTranslation ? parseLyrics(lyricResponse.tlyric) : [];

      // Merge main and translated lyrics based on time
      lyricsData = [];
      let mainIdx = 0;
      let transIdx = 0;

      // This merging logic prioritizes main lyrics and then adds translations that match or are unique
      // It attempts to match a main lyric with a translation if their timestamps are close.
      // Unmatched translations are also included if they have a distinct timestamp.
      while (mainIdx < mainLyrics.length || transIdx < translatedLyrics.length) {
          const mainLine = mainLyrics[mainIdx];
          const transLine = translatedLyrics[transIdx];

          if (mainLine && (!transLine || mainLine.time <= transLine.time + 0.1)) { // Add tolerance for floating point comparison
              const combinedLine = { time: mainLine.time, text: mainLine.text };
              // Find a matching translation within a small time window
              const matchingTransIndex = translatedLyrics.findIndex(t => Math.abs(t.time - mainLine.time) < 0.2); // Increased tolerance for merging
              if (matchingTransIndex !== -1) {
                  combinedLine.translation = translatedLyrics[matchingTransIndex].text;
                  // Remove this translation from translatedLyrics so it's not reused
                  translatedLyrics.splice(matchingTransIndex, 1); // Mutates array, care needed
              } else {
                  combinedLine.translation = '';
              }
              lyricsData.push(combinedLine);
              mainIdx++;
          } else if (transLine) {
              // Add translation without a main lyric if no close match was found
              lyricsData.push({ time: transLine.time, text: '', translation: transLine.text });
              transIdx++;
          }
      }

      // Sort by time just in case, though merging logic should largely maintain order
      lyricsData.sort((a, b) => a.time - b.time);


      const fragment = document.createDocumentFragment(); // Use DocumentFragment for performance
      lyricsData.forEach(line => {
        const l = document.createElement('div');
        l.className = 'lyric-line';
        l.textContent = line.text;
        l.dataset.time = line.time;
        fragment.appendChild(l);

        if (line.translation && line.translation.trim() !== '') {
          const tl = document.createElement('div');
          tl.className = 'lyric-line translation';
          tl.textContent = line.translation;
          tl.dataset.time = line.time; // Keep the same timestamp for translation
          fragment.appendChild(tl);
        }
      });
      lyricsContent.appendChild(fragment);
      currentLyricsResponse = lyricResponse; // Store original for desktop client
    }

    function scrollToLyricLine(el) {
      if (!el) return;
      const container = lyricsScrollContainer;
      const containerHeight = container.clientHeight;
      const elementOffsetTop = el.offsetTop; // Relative to its parent
      const elementHeight = el.clientHeight;

      // Scroll to center the active line
      const scrollTarget = elementOffsetTop - (containerHeight / 2) + (elementHeight / 2);
      container.scrollTo({ top: scrollTarget, behavior: 'smooth' });
    }

    function sendLyricToDesktop(text) {
      if (!desktopLyricsEnabled || !ws || ws.readyState !== WebSocket.OPEN) return;
      try { ws.send(JSON.stringify({ type: 'lyric', text: text || '' })); } catch (e) { console.error('Error sending lyric to desktop:', e); }
    }

    let currentActiveLyricElement = null; // Cache active lyric element
    function updateLyricsHighlight(currentTime) {
      if (!lyricsData.length) { updatePageTitle(); return; }

      let activeLine = null;
      let activeIndex = -1;

      // Find the correct active line from lyricsData
      for (let i = lyricsData.length - 1; i >= 0; i--) {
        if (lyricsData[i].time <= currentTime) {
          activeLine = lyricsData[i];
          activeIndex = i;
          break;
        }
      }

      const allLyricElements = lyricsContent.querySelectorAll('.lyric-line:not(.translation)');

      if (activeIndex === -1 && currentActiveLyricElement) {
        // If no line is active and there was one, clear it
        currentActiveLyricElement.classList.remove('active');
        currentActiveLyricElement = null;
        updatePageTitle();
        sendLyricToDesktop("");
        return;
      }

      if (activeLine) {
        const targetElement = allLyricElements[activeIndex];
        if (targetElement && targetElement !== currentActiveLyricElement) {
          if (currentActiveLyricElement) {
            currentActiveLyricElement.classList.remove('active');
          }
          targetElement.classList.add('active');
          scrollToLyricLine(targetElement);
          currentActiveLyricElement = targetElement;

          const lyricText = activeLine.text;
          if (lyricText && lyricText.trim() !== '') {
            document.title = lyricText;
            isLyricTitleActive = true;
            sendLyricToDesktop(lyricText);
          } else {
            updatePageTitle();
            sendLyricToDesktop(""); // Send empty to clear desktop lyric
            isLyricTitleActive = false;
          }
        }
      }
    }


    // ===== Playlist Management =====
    function initPlaylist() {
      currentActivePlaylist = getActivePlaylistArray();
      renderPlaylist();
    }
    function getActivePlaylistArray() {
      if (currentTab === 'playlist') return playlist;
      if (currentTab === 'favorites') return favorites;
      if (currentTab === 'history') return history;
      return [];
    }
    function renderPlaylist() {
      playlistItems.innerHTML = '';
      const items = getActivePlaylistArray();

      if (items.length === 0) {
        playlistItems.innerHTML = `<div style="padding:15px;color:var(--text-muted-dark);text-align:center;font-style:italic;">
          ${currentTab === 'favorites' ? 'æ”¶è—åˆ—è¡¨ä¸ºç©º' : currentTab === 'history' ? 'æš‚æ— æ’­æ”¾å†å²' : 'æ’­æ”¾åˆ—è¡¨ä¸ºç©º'}</div>`;
        return;
      }

      const fragment = document.createDocumentFragment();
      items.forEach((item, idx) => {
        const d = document.createElement('div');
        d.className = 'playlist-item';
        // Highlight the currently playing song in the main playlist tab
        if (currentTab === 'playlist' && idx === currentPlaylistIdx) {
            d.classList.add('active');
        } else if (currentTab !== 'playlist' && item.id && currentActivePlaylist[currentPlaylistIdx] && item.id === currentActivePlaylist[currentPlaylistIdx].id) {
            // Also highlight in other tabs if the song being played matches an item
             d.classList.add('active');
        }

        const artists = Array.isArray(item.artist) ? item.artist.join('ã€') : (item.artist || 'æœªçŸ¥æ­Œæ‰‹');
        const extra = currentTab === 'history' ? `<div class="playlist-item-time" style="font-size:11px;color:var(--text-muted-dark);margin-top:3px;">${formatDate(item.timestamp)}</div>` : '';
        d.innerHTML = `
          <div class="playlist-item-info">
            <div class="playlist-item-title">${item.name || 'æœªçŸ¥æ­Œæ›²'}</div>
            <div class="playlist-item-artist">${artists}</div>
            ${extra}
          </div>
          ${currentTab === 'playlist' ? `<button class="remove-from-playlist" data-index="${idx}" aria-label="ä»æ’­æ”¾åˆ—è¡¨ç§»é™¤">Ã—</button>` : ''}
        `;
        d.addEventListener('click', () => {
          // Play behavior differs based on tab
          if (currentTab === 'playlist') {
            playFromPlaylist(idx);
          } else {
            // For favorites/history, directly play the item, add to current playlist
            playTrackFromItem(item);
          }
        });
        fragment.appendChild(d);
      });
      playlistItems.appendChild(fragment);

      if (currentTab === 'playlist') {
        document.querySelectorAll('.remove-from-playlist').forEach(btn => {
          btn.addEventListener('click', e => {
            e.stopPropagation();
            const i = parseInt(btn.dataset.index);
            removeFromPlaylist(i);
          });
        });
      }
    }
    function formatDate(ts) { const d = new Date(ts); return `${d.toLocaleDateString()} ${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}`; }
    function savePlaylist() { localStorage.setItem('musicPlaylist', JSON.stringify(playlist)); }
    function saveFavorites() { localStorage.setItem('musicFavorites', JSON.stringify(favorites)); }
    function saveHistory() { localStorage.setItem('musicHistory', JSON.stringify(history)); }

    function addToPlaylist(track) {
      // Check if already in playlist to avoid duplicates based on ID
      const exists = playlist.some(x => x.id === track.id);
      if (!exists) {
        playlist.push(track);
        savePlaylist();
        if (currentTab === 'playlist') renderPlaylist();
        showError('å·²æ·»åŠ åˆ°æ’­æ”¾åˆ—è¡¨', 1500);
      } else {
        showError('æ­Œæ›²å·²åœ¨æ’­æ”¾åˆ—è¡¨ä¸­', 1500);
      }
    }

    function addToFavorites(track) {
      const exists = favorites.some(x => x.id === track.id);
      if (!exists) {
        favorites.push(track);
        saveFavorites();
        if (currentTab === 'favorites') renderPlaylist();
        showError('å·²æ·»åŠ åˆ°æ”¶è—', 1500);
        return true;
      } else {
        showError('æ­Œæ›²å·²åœ¨æ”¶è—åˆ—è¡¨ä¸­', 1500);
        return false;
      }
    }
    function addToHistory(track) {
      // Remove if already exists to update timestamp and move to top
      const existingIdx = history.findIndex(x => x.id === track.id);
      if (existingIdx !== -1) {
        history.splice(existingIdx, 1);
      }
      track.timestamp = Date.now();
      history.push(track);
      if (history.length > 50) history.shift(); // Keep history to a reasonable size
      saveHistory();
      if (currentTab === 'history') renderPlaylist();
    }
    function removeFromPlaylist(index) {
      if (currentPlaylistIdx === index) { // If current playing song is removed
        audioPlayer.pause();
        playerContainer.style.display = 'none';
        currentPlaylistIdx = -1;
        isPlaying = false;
        updatePageTitle();
      } else if (currentPlaylistIdx > index) {
        currentPlaylistIdx--; // Adjust index if a song before it was removed
      }
      playlist.splice(index, 1);
      savePlaylist();
      renderPlaylist(); // Re-render to reflect changes
    }
    function clearCurrentTabItems() {
      if (currentTab === 'playlist') {
        playlist = [];
        savePlaylist();
      } else if (currentTab === 'favorites') {
        favorites = [];
        saveFavorites();
      } else { // history
        history = [];
        saveHistory();
      }
      // If the cleared list was the active one, stop playback
      // Also check if currentPlaying song is from the current tab being cleared
      const currentlyPlayingSongId = currentActivePlaylist[currentPlaylistIdx]?.id;
      if (
          (currentTab === 'playlist' && currentlyPlayingSongId && playlist.every(s => s.id !== currentlyPlayingSongId)) ||
          (currentTab === 'favorites' && currentlyPlayingSongId && favorites.every(s => s.id !== currentlyPlayingSongId)) ||
          (currentTab === 'history' && currentlyPlayingSongId && history.every(s => s.id !== currentlyPlayingSongId))
      ) {
        currentPlaylistIdx = -1;
        audioPlayer.pause();
        playerContainer.style.display = 'none';
        isPlaying = false;
        updatePageTitle();
      }
      renderPlaylist();
    }

    // ===== Network & API Calls =====
    async function fetchLyrics(lyricId) {
      if (!lyricId) return null;
      try {
        const r = await fetch(`https://music-api.gdstudio.xyz/api.php?types=lyric&source=netease&id=${lyricId}`);
        if (!r.ok) throw new Error('æ— æ³•è·å–æ­Œè¯');
        return await r.json();
      } catch (e) { console.error('Error fetching lyrics:', e); return null; }
    }
    async function getAlbumArtUrl(picId) {
      if (!picId) return null;
      try {
        const r = await fetch(`https://music-api.gdstudio.xyz/api.php?types=pic&source=netease&id=${picId}&size=500`);
        if (!r.ok) throw new Error('æ— æ³•è·å–ä¸“è¾‘å›¾ç‰‡');
        const data = await r.json();
        if (!data.url) throw new Error('æ— æ•ˆçš„ä¸“è¾‘å›¾ç‰‡URL');
        return data.url.replace(/\\/g, '');
      } catch (e) { console.error('Error fetching album art:', e); return null; }
    }
    async function loadAlbumArt(picId) {
      albumArt.classList.remove('loaded'); // Prepare for new image fade-in
      albumArt.src = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7'; // Placeholder transparent gif
      if (!picId) return;

      const url = await getAlbumArtUrl(picId);
      if (url) {
        const img = new Image(); // Use Image object to pre-load
        img.src = url;
        img.onload = () => {
          albumArt.src = url;
          albumArt.classList.add('loaded');
        };
        img.onerror = () => { console.error('Failed to load album art image:', url); };
      } else {
        // Fallback or clear if no URL
        albumArt.src = 'https://picsum.photos/500'; // Default placeholder
        albumArt.classList.add('loaded');
      }
    }
    async function getAudioUrl(id) {
      if (!id) throw new Error('ç¼ºå°‘æ­Œæ›²ID');
      try {
        const r = await fetch(`https://music-api.gdstudio.xyz/api.php?types=url&source=netease&id=${id}&br=999`);
        const data = await r.json();
        if (!data.url) throw new Error('æ— æ³•è·å–éŸ³é¢‘é“¾æ¥ï¼Œå¯èƒ½æ˜¯ç‰ˆæƒæˆ–VIPæ­Œæ›²');
        return data.url.replace(/\\/g, '');
      } catch (e) { console.error('Error fetching audio URL:', e); throw e; }
    }
    async function getRandomBackground() {
      try {
        const types = ['wallpaper', 'acg'];
        const tp = types[Math.floor(Math.random() * types.length)];
        const r = await fetch(`https://v2.xxapi.cn/api/random4kPic?type=${tp}`);
        if (!r.ok) throw new Error('æ— æ³•è·å–èƒŒæ™¯å›¾ç‰‡');
        const data = await r.json();
        return data.data;
      } catch (e) { console.error('Error fetching background:', e); return null; }
    }
    async function updateBackground() {
      const url = await getRandomBackground();
      if (url) {
        const img = new Image();
        img.src = url;
        img.onload = () => {
            document.body.style.backgroundImage = `url(${url})`;
            currentWallpaperUrl = url;
            saveWallpaperBtn.style.display = 'block';
        };
        img.onerror = () => { console.error('Failed to load background image:', url); };
      }
    }

    // ===== Search & Play Logic =====
    async function searchMusic(query, page = 1) {
      if (!query.trim()) { showError('è¯·è¾“å…¥æœç´¢å†…å®¹'); return; }
      try {
        showLoading();
        clearError();
        const r = await fetch(`https://music-api.gdstudio.xyz/api.php?types=search&source=netease&name=${encodeURIComponent(query)}&count=20&pages=${page}`);
        if (!r.ok) throw new Error('æœç´¢å¤±è´¥ï¼Œè¯·ç¨åå†è¯•');
        const data = await r.json();
        if (!data || data.length === 0) throw new Error('æœªæ‰¾åˆ°ç›¸å…³æ­Œæ›²');
        currentSearchResults = data;
        displaySearchResults(data);
        updatePagination(page);
        currentPage = page; // Update current page
      } catch (e) {
        showError(e.message);
        searchResults.innerHTML = ''; // Clear previous results on error
        pagination.innerHTML = '';
      } finally {
        hideLoading();
      }
    }

    function displaySearchResults(results) {
      searchResults.innerHTML = '';
      if (results.length === 0) {
        searchResults.innerHTML = '<div class="result-item" style="justify-content:center;">æœªæ‰¾åˆ°ç›¸å…³æ­Œæ›²</div>';
        return;
      }
      const fragment = document.createDocumentFragment();
      results.forEach((song, idx) => {
        const item = document.createElement('div');
        item.className = 'result-item';
        // No active state for search results, as playing from search is temporary
        const artists = Array.isArray(song.artist) ? song.artist.join('ã€') : (song.artist || 'æœªçŸ¥æ­Œæ‰‹');
        item.innerHTML = `
          <div class="song-info">
            <div class="song-title">${song.name || 'æœªçŸ¥æ­Œæ›²'}</div>
            <div class="song-artist">${artists}</div>
            <div class="song-album">${song.album || 'æœªçŸ¥ä¸“è¾‘'}</div>
          </div>
          <div class="actions">
            <button class="add-to-playlist" data-index="${idx}" title="æ·»åŠ åˆ°æ’­æ”¾åˆ—è¡¨"><i class="fas fa-plus"></i></button>
            <button class="add-to-favorites" data-index="${idx}" title="æ·»åŠ åˆ°æ”¶è—"><i class="fas fa-heart"></i></button>
          </div>`;
        item.addEventListener('click', () => playTrack(idx));
        const addBtn = item.querySelector('.add-to-playlist');
        addBtn.addEventListener('click', e => { e.stopPropagation(); addToPlaylist(currentSearchResults[parseInt(addBtn.dataset.index)]); });
        const favBtn = item.querySelector('.add-to-favorites');
        favBtn.addEventListener('click', e => {
          e.stopPropagation();
          const added = addToFavorites(currentSearchResults[parseInt(favBtn.dataset.index)]);
          if (added) {
            favBtn.innerHTML = '<i class="fas fa-check"></i>';
            setTimeout(() => { favBtn.innerHTML = '<i class="fas fa-heart"></i>'; }, 1000);
          }
        });
        fragment.appendChild(item);
      });
      searchResults.appendChild(fragment);
    }
    function updatePagination(curPage) {
      pagination.innerHTML = '';
      const prev = document.createElement('button');
      prev.className = 'page-button';
      prev.textContent = 'ä¸Šä¸€é¡µ';
      prev.disabled = curPage <= 1;
      prev.addEventListener('click', () => { if (curPage > 1) searchMusic(searchInput.value.trim(), curPage - 1); });

      const info = document.createElement('span');
      info.className = 'page-button'; // Re-use styling but prevent click
      info.textContent = `ç¬¬ ${curPage} é¡µ`;
      info.style.cursor = 'default';
      info.style.pointerEvents = 'none'; // Make non-clickable

      const next = document.createElement('button');
      next.className = 'page-button';
      next.textContent = 'ä¸‹ä¸€é¡µ';
      // For simplicity, always allow next page in this API, as total pages are unknown
      next.addEventListener('click', () => searchMusic(searchInput.value.trim(), curPage + 1));

      pagination.appendChild(prev);
      pagination.appendChild(info);
      pagination.appendChild(next);
    }

    async function playSong(song, isFromPlaylist = false, index = -1) {
        try {
            showLoading();
            clearError();

            nowPlayingTitle.textContent = song.name || 'æœªçŸ¥æ­Œæ›²';
            nowPlayingArtist.textContent = Array.isArray(song.artist) ? song.artist.join('ã€') : (song.artist || 'æœªçŸ¥æ­Œæ‰‹');
            nowPlayingAlbum.textContent = song.album || 'æœªçŸ¥ä¸“è¾‘';

            sendSongInfoToDesktop(); // Update desktop lyrics client
            await loadAlbumArt(song.pic_id);

            const lyr = await fetchLyrics(song.lyric_id); // Correct variable name
            displayLyrics(lyr); // Correct variable name
            sendFullLyricsToDesktop(lyr);

            const audioUrl = await getAudioUrl(song.id);
            audioPlayer.src = audioUrl;
            playerContainer.style.display = 'flex';

            await audioPlayer.play()
                .then(() => {
                    playButton.textContent = 'â¸';
                    isPlaying = true;
                    updatePageTitle();
                    addToHistory(song); // Add to history regardless of source
                    if (isFromPlaylist) {
                        currentPlaylistIdx = index;
                        currentActivePlaylist = playlist; // Ensure correct array is referenced
                        renderPlaylist(); // Update UI to show active song
                    } else {
                        currentTrackIndex = -1; // Not playing from search results directly
                        currentPlaylistIdx = -1; // Not playing from current playlist by index
                        // If it's a "play track from item" action, it should also be added to current playlist if not already there
                        // For now, we only update playlist when explicitly added
                    }
                })
                .catch(e => {
                    playButton.textContent = 'â–¶';
                    isPlaying = false;
                    updatePageTitle();
                    if (e.name === "NotAllowedError" || e.name === "AbortError") {
                        showError('æ’­æ”¾è¢«é˜»æ­¢ï¼šæµè§ˆå™¨éœ€è¦ç”¨æˆ·äº¤äº’æ‰èƒ½å¼€å§‹æ’­æ”¾ã€‚è¯·ç‚¹å‡»æ’­æ”¾æŒ‰é’®ã€‚');
                    } else if (isMobile()) {
                        showError('è¯·ç‚¹å‡»æ’­æ”¾æŒ‰é’®ç¡®è®¤æ’­æ”¾ï¼Œæˆ–æ­Œæ›²æ— æ³•æ’­æ”¾: ' + e.message);
                    } else {
                        showError('æ’­æ”¾å¤±è´¥: ' + e.message);
                    }
                });
            await updateBackground();
        } catch (e) {
            showError(e.message);
            playButton.textContent = 'â–¶';
            isPlaying = false;
            updatePageTitle();
        } finally {
            hideLoading();
        }
    }

    async function playFromPlaylist(index) {
        if (index < 0 || index >= playlist.length) return;
        currentActivePlaylist = playlist; // Set active playlist context
        await playSong(playlist[index], true, index);
    }

    async function playTrackFromItem(item) {
        // This is typically called from favorites/history tab.
        // It plays the item, but doesn't set it as "currentPlaylistIdx" because it's not from the main 'playlist' array.
        // If the user wants to add it to the main playlist, they should use the add button.
        currentActivePlaylist = []; // Clear context, as this is a standalone play
        currentPlaylistIdx = -1;
        await playSong(item, false, -1);
    }

    async function playTrack(index) { // Play from search results
        if (index < 0 || index >= currentSearchResults.length) return;
        currentActivePlaylist = currentSearchResults; // Temporarily consider search results as active list
        await playSong(currentSearchResults[index], false, index);
        // Important: Reset currentPlaylistIdx to -1 since it's not part of the persistent playlist
        currentPlaylistIdx = -1;
    }


    // ===== Desktop Lyrics (WebSocket) =====
    function sendSongInfoToDesktop() {
      if (!desktopLyricsEnabled || !ws || ws.readyState !== WebSocket.OPEN) return;
      try { ws.send(JSON.stringify({ type: 'song', song: nowPlayingTitle.textContent || 'æœªçŸ¥æ­Œæ›²', artist: nowPlayingArtist.textContent || 'æœªçŸ¥æ­Œæ‰‹' })); } catch (e) { console.error('Error sending song info to desktop:', e); }
    }
    function sendFullLyricsToDesktop(lyricsResponse) {
      if (!desktopLyricsEnabled || !ws || ws.readyState !== WebSocket.OPEN || !lyricsResponse) return;
      try { ws.send(JSON.stringify({ type: 'full_lyric', lyric: lyricsResponse.lyric || '', tlyric: lyricsResponse.tlyric || '' })); } catch (e) { console.error('Error sending full lyrics to desktop:', e); }
    }
    function sendCurrentTimeToDesktop(t) {
      if (!desktopLyricsEnabled || !ws || ws.readyState !== WebSocket.OPEN) return;
      try { ws.send(JSON.stringify({ type: 'time', currentTime: t })); } catch (e) { console.error('Error sending current time to desktop:', e); }
    }
    function connectToDesktopLyrics() {
      desktopLyricsStatus.style.display = 'block';
      if (ws && (ws.readyState === WebSocket.OPEN || ws.readyState === WebSocket.CONNECTING)) {
        console.log('WebSocket already open or connecting.');
        return;
      }
      if (ws) ws.close(); // Close existing connection if any
      ws = new WebSocket('ws://localhost:8765'); // Standard port for desktop lyrics clients

      ws.onopen = () => {
        desktopLyricsStatus.textContent = 'å·²è¿æ¥åˆ°æ¡Œé¢æ­Œè¯ç¨‹åº';
        desktopLyricsStatus.classList.remove('disconnected');
        desktopLyricsStatus.classList.add('connected');
        desktopLyricsEnabled = true;
        if (nowPlayingTitle.textContent && nowPlayingTitle.textContent !== 'æ­Œæ›²æ ‡é¢˜') { sendSongInfoToDesktop(); }
        if (currentLyricsResponse) { sendFullLyricsToDesktop(currentLyricsResponse); }
        if (audioPlayer.currentTime) { sendCurrentTimeToDesktop(audioPlayer.currentTime); }
      };
      ws.onerror = (e) => {
        console.error('Desktop Lyrics WebSocket error:', e);
        desktopLyricsStatus.textContent = 'è¿æ¥æ¡Œé¢æ­Œè¯å¤±è´¥';
        desktopLyricsStatus.classList.add('disconnected');
        desktopLyricsEnabled = false;
        ws = null; // Clear websocket on error to allow reconnection
      };
      ws.onclose = () => {
        desktopLyricsStatus.textContent = 'æ¡Œé¢æ­Œè¯è¿æ¥å·²æ–­å¼€';
        desktopLyricsStatus.classList.remove('connected');
        desktopLyricsStatus.classList.add('disconnected');
        desktopLyricsEnabled = false;
        ws = null; // Clear websocket on close
      };
    }
    function disconnectDesktopLyrics() {
        if (ws) {
            ws.close();
        }
        desktopLyricsEnabled = false;
        desktopLyricsStatus.textContent = 'æ¡Œé¢æ­Œè¯å·²å…³é—­';
        desktopLyricsStatus.classList.remove('connected', 'disconnected');
    }

    // ===== Event Listeners =====
    function showLoading() { loadingIndicator.classList.add('active'); }
    function hideLoading() { loadingIndicator.classList.remove('active'); }

    // Removed: searchInput.addEventListener('input', debounce(...))
    // Search will now only be triggered on button click or Enter key.

    searchButton.addEventListener('click', () => searchMusic(searchInput.value.trim()));
    searchInput.addEventListener('keypress', e => { if (e.key === 'Enter') searchMusic(searchInput.value.trim()); });

    lyricsContent.addEventListener('click', e => {
      const target = e.target.closest('.lyric-line');
      if (!target) return;
      const t = parseFloat(target.dataset.time);
      if (isNaN(t) || t < 0) return; // Ignore non-timed lines

      try {
        audioPlayer.currentTime = t;
        // The timeupdate event will handle highlight and scrolling
        if (audioPlayer.paused) {
          audioPlayer.play().then(() => { playButton.textContent = 'â¸'; isPlaying = true; updatePageTitle(); }).catch(() => {});
        }
      } catch (_) { console.error("Error setting currentTime:", _); }
    });

    playButton.addEventListener('click', () => {
      clearError();
      if (audioPlayer.paused) {
        audioPlayer.play().then(() => {
          playButton.textContent = 'â¸';
          isPlaying = true;
          updatePageTitle();
        }).catch(e => {
          if (e.name === "NotAllowedError" || e.name === "AbortError") {
              showError('æ’­æ”¾è¢«é˜»æ­¢ï¼šæµè§ˆå™¨éœ€è¦ç”¨æˆ·äº¤äº’æ‰èƒ½å¼€å§‹æ’­æ”¾ã€‚è¯·ç‚¹å‡»æ’­æ”¾æŒ‰é’®ã€‚');
          } else if (isMobile()) {
              showError('è¯·ç‚¹å‡»æ’­æ”¾æŒ‰é’®ç¡®è®¤æ’­æ”¾ï¼Œæˆ–æ­Œæ›²æ— æ³•æ’­æ”¾: ' + e.message);
          } else {
              showError('æ’­æ”¾å¤±è´¥: ' + e.message);
          }
        });
      } else {
        audioPlayer.pause();
        playButton.textContent = 'â–¶';
        isPlaying = false;
        updatePageTitle();
      }
    });

    prevButton.addEventListener('click', () => {
      if (currentActivePlaylist.length === 0) {
        showError('æ’­æ”¾åˆ—è¡¨ä¸ºç©ºï¼Œæ— æ³•åˆ‡æ¢æ­Œæ›²');
        return;
      }

      if (currentPlayMode === 'shuffle') {
        const randomIndex = Math.floor(Math.random() * currentActivePlaylist.length);
        playSong(currentActivePlaylist[randomIndex], true, randomIndex);
      } else {
        let newIndex = currentPlaylistIdx - 1;
        if (newIndex < 0) newIndex = currentActivePlaylist.length - 1; // Wrap around
        playSong(currentActivePlaylist[newIndex], true, newIndex);
      }
    });

    nextButton.addEventListener('click', () => {
      if (currentActivePlaylist.length === 0) {
        showError('æ’­æ”¾åˆ—è¡¨ä¸ºç©ºï¼Œæ— æ³•åˆ‡æ¢æ­Œæ›²');
        return;
      }

      if (currentPlayMode === 'shuffle') {
        const randomIndex = Math.floor(Math.random() * currentActivePlaylist.length);
        playSong(currentActivePlaylist[randomIndex], true, randomIndex);
      } else {
        let newIndex = currentPlaylistIdx + 1;
        if (newIndex >= currentActivePlaylist.length) newIndex = 0; // Wrap around
        playSong(currentActivePlaylist[newIndex], true, newIndex);
      }
    });

    progressBar.addEventListener('click', e => {
      const rect = progressBar.getBoundingClientRect();
      const clickX = e.clientX - rect.left;
      const percent = clickX / rect.width;
      const duration = audioPlayer.duration;
      if (duration && !isNaN(duration)) {
        audioPlayer.currentTime = percent * duration;
      }
    });

    audioPlayer.addEventListener('timeupdate', () => {
      const { currentTime, duration } = audioPlayer;
      if (duration && !isNaN(duration)) {
        const p = (currentTime / duration) * 100;
        progress.style.width = `${p}%`;
        progressBar.setAttribute('aria-valuenow', p); // Update ARIA value
        currentTimeDisplay.textContent = formatTime(currentTime);
        durationDisplay.textContent = formatTime(duration);
        updateLyricsHighlight(currentTime);
        sendCurrentTimeToDesktop(currentTime);
      }
    });

    audioPlayer.addEventListener('ended', () => {
      isPlaying = false;
      updatePageTitle();
      playButton.textContent = 'â–¶';
      if (currentActivePlaylist.length === 0) return; // If list is empty, stop here

      if (currentPlayMode === 'repeat') {
        // Play current song again
        if (currentPlaylistIdx >= 0 && currentPlaylistIdx < currentActivePlaylist.length) {
          playSong(currentActivePlaylist[currentPlaylistIdx], true, currentPlaylistIdx);
        } else {
          // If currentPlaylistIdx is invalid, try playing first song or stop
          playSong(currentActivePlaylist[0], true, 0);
        }
      } else if (currentPlayMode === 'shuffle') {
        const randomIndex = Math.floor(Math.random() * currentActivePlaylist.length);
        playSong(currentActivePlaylist[randomIndex], true, randomIndex);
      } else { // normal mode
        let newIndex = currentPlaylistIdx + 1;
        if (newIndex < currentActivePlaylist.length) {
          playSong(currentActivePlaylist[newIndex], true, newIndex);
        } else {
          // End of playlist, stop or loop if desired
          // For now, it stops
        }
      }
    });

    audioPlayer.addEventListener('loadedmetadata', () => {
      const { currentTime, duration } = audioPlayer;
      currentTimeDisplay.textContent = formatTime(currentTime);
      durationDisplay.textContent = formatTime(duration);
    });
    audioPlayer.addEventListener('play', () => { isPlaying = true; updatePageTitle(); });
    audioPlayer.addEventListener('pause', () => { isPlaying = false; updatePageTitle(); });

    volumeSlider.addEventListener('input', debounce((e) => {
      audioPlayer.volume = parseFloat(e.target.value);
      localStorage.setItem('musicPlayerVolume', audioPlayer.volume); // Save volume
    }, 50)); // Debounce volume input

    clearPlaylist.addEventListener('click', clearCurrentTabItems); // Changed to clear current tab's items
    themeToggle.addEventListener('click', toggleTheme);

    playModeBtn.addEventListener('click', () => {
      const modes = ['normal', 'repeat', 'shuffle'];
      const icons = ['fa-redo', 'fa-repeat', 'fa-random'];
      const titles = ['å¾ªç¯æ’­æ”¾', 'å•æ›²å¾ªç¯', 'éšæœºæ’­æ”¾'];
      const idx = modes.indexOf(currentPlayMode);
      const next = (idx + 1) % modes.length;
      currentPlayMode = modes[next];
      playModeBtn.innerHTML = `<i class="fas ${icons[next]}"></i>`;
      playModeBtn.title = titles[next];
      showError(`æ’­æ”¾æ¨¡å¼å·²åˆ‡æ¢ä¸º: ${titles[next]}`, 1500);
    });

    desktopLyricsBtn.addEventListener('click', () => {
      if (!desktopLyricsEnabled) connectToDesktopLyrics();
      else disconnectDesktopLyrics();
    });

    saveWallpaperBtn.addEventListener('click', () => {
      if (currentWallpaperUrl) {
        const a = document.createElement('a');
        a.href = currentWallpaperUrl;
        a.download = `Harmonia_Wallpaper_${new Date().getTime()}.jpg`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        showError('å£çº¸å·²ä¿å­˜ï¼', 1500);
      } else {
        showError('æš‚æ— å£çº¸å¯ä¿å­˜', 1500);
      }
    });

    shareMusicBtn.addEventListener('click', () => {
      if (playlist.length === 0) { showError('æ’­æ”¾åˆ—è¡¨ä¸ºç©ºï¼Œæ— æ³•åˆ†äº«'); return; }
      createShareModal();
    });

    // æ ‡ç­¾é¡µ
    playlistTabs.forEach(tab => {
      tab.addEventListener('click', () => {
        playlistTabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        currentTab = tab.dataset.tab;
        currentActivePlaylist = getActivePlaylistArray(); // Update the active playlist array reference
        renderPlaylist();
      });
    });

    // ä¸“è¾‘å°é¢ 3D æ•ˆæœ
    albumArtContainer.addEventListener('mousemove', e => {
      const rect = albumArtContainer.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      const cx = rect.width / 2, cy = rect.height / 2;
      const ry = (x - cx) / 15; // Reduced intensity
      const rx = (cy - y) / 15; // Reduced intensity
      albumArtContainer.style.transform = `perspective(1000px) rotateX(${rx}deg) rotateY(${ry}deg)`;
    });
    albumArtContainer.addEventListener('mouseleave', () => { albumArtContainer.style.transform = 'perspective(1000px) rotateX(0) rotateY(0)'; });

    // åˆ†äº«æ¨¡æ€æ¡† (Optimized to be created once and shown/hidden)
    let shareModalOverlay = null; // Cache the modal overlay

    function createShareModal() {
      if (!shareModalOverlay) {
        shareModalOverlay = document.createElement('div');
        shareModalOverlay.className = 'modal-overlay';
        shareModalOverlay.id = 'shareModalOverlay'; // Add an ID for easier reference

        const box = document.createElement('div');
        box.className = 'modal-content';

        const title = document.createElement('h2');
        title.textContent = 'åˆ†äº«æ­Œæ›²';

        const tip = document.createElement('p');
        tip.textContent = 'é€‰æ‹©è¦åˆ†äº«çš„æ­Œæ›²ï¼ˆå¯å¤šé€‰ï¼‰ï¼Œç„¶åç‚¹å‡»"å¯¼å‡ºåˆ†äº«æ–‡ä»¶"æŒ‰é’®';

        const list = document.createElement('div');
        list.className = 'modal-song-list';
        list.id = 'shareSongList'; // ID for dynamically updated content

        const btnsContainer = document.createElement('div');
        btnsContainer.className = 'modal-buttons';

        const btnExport = document.createElement('button');
        btnExport.textContent = 'å¯¼å‡ºåˆ†äº«æ–‡ä»¶';
        btnExport.className = 'btn-export';
        btnExport.addEventListener('click', () => {
          const selected = [...shareModalOverlay.querySelectorAll('.modal-song-row input[type="checkbox"]:checked')].map(cb => playlist[parseInt(cb.dataset.index)]);
          if (selected.length === 0) { showError('è¯·è‡³å°‘é€‰æ‹©ä¸€é¦–æ­Œæ›²'); return; }
          exportSongs(selected);
          hideShareModal();
        });

        const btnImport = document.createElement('button');
        btnImport.textContent = 'å¯¼å…¥åˆ†äº«æ–‡ä»¶';
        btnImport.className = 'btn-import';
        btnImport.addEventListener('click', () => {
          const input = document.createElement('input');
          input.type = 'file';
          input.accept = '.json,.txt';
          input.addEventListener('change', e => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = ev => {
              try {
                const imported = JSON.parse(ev.target.result);
                if (Array.isArray(imported)) {
                  const add = imported.filter(x => !playlist.some(y => y.id === x.id));
                  if (add.length > 0) {
                    playlist = [...playlist, ...add];
                    savePlaylist();
                    if (currentTab === 'playlist') renderPlaylist();
                    showError(`æˆåŠŸå¯¼å…¥ ${add.length} é¦–æ­Œæ›²`);
                  } else {
                    showError('æ²¡æœ‰æ–°æ­Œæ›²å¯ä»¥å¯¼å…¥');
                  }
                } else {
                  showError('æ— æ•ˆçš„åˆ†äº«æ–‡ä»¶');
                }
              } catch { showError('æ— æ³•è§£æåˆ†äº«æ–‡ä»¶'); }
            };
            reader.readAsText(file);
          });
          input.click();
          hideShareModal();
        });

        btnsContainer.appendChild(btnExport);
        btnsContainer.appendChild(btnImport);

        const btnClose = document.createElement('button'); // Defined outside btnsContainer
        btnClose.textContent = 'å–æ¶ˆ';
        btnClose.className = 'btn-cancel'; // Custom class for styling
        btnClose.addEventListener('click', hideShareModal);

        box.appendChild(title);
        box.appendChild(tip);
        box.appendChild(list);
        box.appendChild(btnsContainer);
        box.appendChild(btnClose); // Appended directly to box

        shareModalOverlay.appendChild(box);
        shareModalOverlay.style.display = 'none'; // Initially hidden
        document.body.appendChild(shareModalOverlay);

        // Close when clicking outside the modal content
        shareModalOverlay.addEventListener('click', e => {
          if (e.target === shareModalOverlay) {
            hideShareModal();
          }
        });
      }

      // Update song list each time modal is opened
      const shareSongList = document.getElementById('shareSongList');
      shareSongList.innerHTML = '';
      const fragment = document.createDocumentFragment();
      playlist.forEach((song, idx) => {
        const row = document.createElement('div');
        row.className = 'modal-song-row';
        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.dataset.index = idx;
        const info = document.createElement('div');
        info.className = 'modal-song-info';
        const st = document.createElement('div');
        st.textContent = song.name || 'æœªçŸ¥æ­Œæ›²';
        st.className = 'modal-song-title';
        const sa = document.createElement('div');
        sa.textContent = Array.isArray(song.artist) ? song.artist.join('ã€') : (song.artist || 'æœªçŸ¥æ­Œæ‰‹');
        sa.className = 'modal-song-artist';
        info.appendChild(st);
        info.appendChild(sa);
        row.appendChild(cb);
        row.appendChild(info);
        row.addEventListener('click', e => { if (e.target !== cb) cb.checked = !cb.checked; });
        fragment.appendChild(row);
      });
      shareSongList.appendChild(fragment);

      // Show modal with animation
      shareModalOverlay.style.display = 'flex'; // Make it visible (display:flex)
      // Add a slight delay to allow display:flex to apply before starting transition
      requestAnimationFrame(() => {
          shareModalOverlay.classList.add('show'); // Then add 'show' for opacity/transform animation
      });
    }

    function hideShareModal() {
      if (shareModalOverlay) {
        shareModalOverlay.classList.remove('show');
        // Wait for the transition to complete before setting display: none
        setTimeout(() => {
          // Only set display to none if the modal is not currently being shown (e.g., another call to showModal didn't happen)
          if (!shareModalOverlay.classList.contains('show')) {
             shareModalOverlay.style.display = 'none';
          }
        }, 300); // This delay should match your CSS transition duration for .modal-overlay
      }
    }

    function exportSongs(songs) {
      const data = JSON.stringify(songs, null, 2);
      const blob = new Blob([data], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `HarmoniaéŸ³ä¹åˆ†äº«_${new Date().toLocaleDateString()}.json`;
      document.body.appendChild(a);
      a.click();
      setTimeout(() => { document.body.removeChild(a); URL.revokeObjectURL(url); }, 100);
      showError(`å·²å¯¼å‡º ${songs.length} é¦–æ­Œæ›²ï¼`, 2000);
    }

    // ===== æŠ˜å é€»è¾‘ï¼ˆä»…åˆ—è¡¨ï¼‰ =====
    function bindCollapsible(button, bodyEl, storageKey, expandLabel, collapseLabel) {
      if (!button || !bodyEl) return;
      let collapsed = localStorage.getItem(storageKey) === '1';
      const apply = () => {
        const icon = button.querySelector('i');
        if (collapsed) {
          bodyEl.classList.add('hidden');
          button.setAttribute('aria-expanded', 'false');
          button.title = expandLabel;
          if (icon) icon.style.transform = 'rotate(180deg)';
        } else {
          bodyEl.classList.remove('hidden');
          button.setAttribute('aria-expanded', 'true');
          button.title = collapseLabel;
          if (icon) icon.style.transform = 'rotate(0deg)';
        }
        localStorage.setItem(storageKey, collapsed ? '1' : '0');
      };
      apply();
      button.addEventListener('click', () => { collapsed = !collapsed; apply(); });
    }

    // ===== Init =====
    function init() {
      initTheme();
      updateBackground();
      initPlaylist();
      optimizeMobileButtons();
      bindCollapsible(collapsePlaylistBtn, playlistCollapsible, 'musicPlaylistCollapsed', 'å±•å¼€åˆ—è¡¨', 'æ”¶èµ·åˆ—è¡¨');
    }
    init();
  </script>
</body>
</html>
